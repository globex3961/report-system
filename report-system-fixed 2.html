<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>课程目标达成度分析报告生成系统</title>
    <!-- Tailwind CSS CDN（外部资源） -->
    <script src="https://cdn.tailwindcss.com/3.4.16"></script>
    <!-- Chart.js CDN（外部资源） -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <!-- 自定义Tailwind配置，设置全局样式 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4f46e5',
                        secondary: '#64748b',
                        accent: '#f59e0b',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .form-input-focus {
                @apply focus:ring-2 focus:ring-primary/50 focus:border-primary;
            }
            .card-shadow {
                @apply shadow-md hover:shadow-lg transition-shadow duration-300;
            }
        }
    </style>
    <!-- 自定义样式，避免CDN依赖问题 -->
    <style>
        /* 自定义样式 */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.5;
        }
        .step-content.hidden {
            display: none !important;
        }
        table {
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #e5e7eb;
            padding: 8px;
        }
        th {
            background-color: #f9fafb;
        }
        button {
            cursor: pointer;
        }
        textarea, input {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- 顶部导航栏 -->
    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-primary">课程目标达成度分析报告生成系统2.0</h1>
            <div class="text-gray-600">
                <span id="current-date" class="mr-4"></span>
                <button id="export-report" class="bg-primary text-white px-4 py-2 rounded-md hover:bg-primary/90 transition-colors">
                    导出分析报告
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <!-- 步骤导航栏 -->
        <div class="flex flex-wrap mb-8 border-b border-gray-200">
            <button class="step-btn px-6 py-3 font-medium text-primary border-b-2 border-primary" data-step="1">
                1. 课程信息与目标设置
            </button>
            <button class="step-btn px-6 py-3 font-medium text-gray-500 hover:text-primary" data-step="2">
                2. 权重设置
            </button>
            <button class="step-btn px-6 py-3 font-medium text-gray-500 hover:text-primary" data-step="3">
                3. 学生成绩录入
            </button>
            <button class="step-btn px-6 py-3 font-medium text-gray-500 hover:text-primary" data-step="4">
                4. 课程目标达成分析
            </button>
        </div>

        <!-- 步骤1：课程信息与目标设置 -->
        <div class="step-content" id="step-1">
            <div class="bg-white rounded-lg p-6 card-shadow mb-8">
                <h2 class="text-xl font-semibold mb-4">课程基本信息</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-gray-700 mb-2">课程名称</label>
                                <input type="text" id="course-name" value="《常微分方程》" 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-md form-input-focus">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">班级</label>
                        <input type="text" id="class-name" value="2023级" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-md form-input-focus">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">学生人数</label>
                                <input type="number" id="student-count" value="93" min="1"
                                       class="w-full px-4 py-2 border border-gray-300 rounded-md form-input-focus">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">评价人</label>
                                <input type="text" id="evaluator" value="黎琳"
                                       class="w-full px-4 py-2 border border-gray-300 rounded-md form-input-focus">
                    </div>


                </div>

                <h3 class="text-lg font-semibold mt-6 mb-4">课程目标设置</h3>
                <div id="course-objectives">
                    <!-- 课程目标1 -->
                    <div class="objective-item border border-gray-200 rounded-md p-4 mb-4">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-medium">课程目标1</h4>
                            <button class="delete-objective-btn text-red-500 hover:text-red-700 text-sm">删除</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-gray-700 mb-2">目标描述</label>
                                <textarea id="objective-1-desc" rows="3" 
                                          class="w-full px-4 py-2 border border-gray-300 rounded-md form-input-focus">树立微积分意识，培养方程思想，掌握常微分方程的基础理论和方法，初步掌握数学建模的一些基本方法，提高学生的逻辑思维和推理能力。初步了解当今自然科学和社会科学中的一些非线性问题，培养学生运用微分方程理论方法向微分方程模型应用转化的分析问题和解决问题的能力，提高学生的分析能力、逻辑推理能力以及数学表达能力。</textarea>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2">对应毕业要求指标点</label>
                                <input type="text" id="objective-1-requirement" value="毕业要求3：学科素养"
                                       class="w-full px-4 py-2 border border-gray-300 rounded-md form-input-focus">
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2">支撑程度</label>
                                <select id="objective-1-support-level" 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-md form-input-focus">
                                    <option value="H">H（高）</option>
                                    <option value="M">M（中）</option>
                                    <option value="L">L（低）</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2">对应毕业要求具体指标点</label>
                                <textarea id="objective-1-specific-requirement" rows="3" 
                                          class="w-full px-4 py-2 border border-gray-300 rounded-md form-input-focus">3.1【学科知识】掌握数学学科的基本知识、基本原理和基本技能，系统习得逻辑推理、符号演算、科学计算、数学建模和数据分析等基本技能，形成良好的数学思维能力和较强的数学表达能力。
3.2【知识体系】理解数学学科知识体系的基本思想和方法，了解数学学科发展历史，了解初等数学与高等数学的内在联系。
3.3【知识应用】了解数学学科与物理学、统计学和信息技术等相关学科的联系，了解数学学科与社会实践领域的联系，初步具备利用数学学科知识及信息技术等相关学科知识解决实际问题的能力。
3.4【知识整合】了解数学学科教育教学知识，了解问题解决学习、项目学习和研究性学习的路径和方法，能够在教育教学实践中，运用数学学科知识和学习科学知识分析和解决学科教学内容问题。</textarea>
                            </div>

                        </div>
                    </div>

                    <!-- 课程目标2 -->
                    <div class="objective-item border border-gray-200 rounded-md p-4 mb-4">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-medium">课程目标2</h4>
                            <button class="delete-objective-btn text-red-500 hover:text-red-700 text-sm">删除</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-gray-700 mb-2">目标描述</label>
                                <textarea id="objective-2-desc" rows="3" 
                                          class="w-full px-4 py-2 border border-gray-300 rounded-md form-input-focus">在教育实践中，能够根据教育教学理论、中学数学课程标准，结合中学生身心发展和学科认知特点，注重常微分方程课程对中学数学教学的指导作用的研究与实践，运用现代信息技术，初步掌握重难点教学策略、结构化学习指导和学科思维方式培养等教学知识，具备教学基本技能。</textarea>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2">对应毕业要求指标点</label>
                                <input type="text" id="objective-2-requirement" value="毕业要求4：教学能力"
                                       class="w-full px-4 py-2 border border-gray-300 rounded-md form-input-focus">
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2">支撑程度</label>
                                <select id="objective-2-support-level" 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-md form-input-focus">
                                    <option value="H">H（高）</option>
                                    <option value="M">M（中）</option>
                                    <option value="L" selected>L（低）</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2">对应毕业要求具体指标点</label>
                                <textarea id="objective-2-specific-requirement" rows="3" 
                                          class="w-full px-4 py-2 border border-gray-300 rounded-md form-input-focus">4.1【教育基础】掌握教育学、心理学等教育教学基本理论和方法。能够根据教育教学理论、中学数学课程标准，结合中学生身心发展和数学学科认知特点，初步掌握重难点教学策略、结构化学习指导和学科思维方式培养等数学学科教学知识。</textarea>
                            </div>

                        </div>
                    </div>

                    <!-- 课程目标3 -->
                    <div class="objective-item border border-gray-200 rounded-md p-4 mb-4">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-medium">课程目标3</h4>
                            <button class="delete-objective-btn text-red-500 hover:text-red-700 text-sm">删除</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-gray-700 mb-2">目标描述</label>
                                <textarea id="objective-3-desc" rows="3" 
                                          class="w-full px-4 py-2 border border-gray-300 rounded-md form-input-focus">通过了解常微分方程学科发展历程、发展趋势以及课程知识体系和基本思想方法，形成专业发展意识，树立终身学习的理念，理性分析自我，制定专业学习与职业发展规划。在课程教学过程中，从独立思考、细心做题、仔细检查等方面对学生良好的学习习惯的培养，养成从学生学习、课程教学、教育实践等不同角度反思问题的习惯，能够通过自我诊断和自我改进，学会分析和解决中学数学学科中的教育教学问题。</textarea>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2">对应毕业要求指标点</label>
                                <input type="text" id="objective-3-requirement" value="毕业要求7：学会反思"
                                       class="w-full px-4 py-2 border border-gray-300 rounded-md form-input-focus">
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2">支撑程度</label>
                                <select id="objective-3-support-level" 
                                        class="w-full px-4 py-2 border border-gray-300 rounded-md form-input-focus">
                                    <option value="H">H（高）</option>
                                    <option value="M" selected>M（中）</option>
                                    <option value="L">L（低）</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-2">对应毕业要求具体指标点</label>
                                <textarea id="objective-3-specific-requirement" rows="3" 
                                          class="w-full px-4 py-2 border border-gray-300 rounded-md form-input-focus">7.1【发展规划】了解专业发展的相关知识，形成专业发展意识，树立终身学习的理念，了解基础教育改革数学学科发展动态，理性分析自我，制定专业学习与职业发展规划。
7.2【反思改进】学会运用批判性思维方法，养成从学生学习、课程教学、教育实践等不同角度反思问题的习惯，能够通过自我诊断和自我改进，学会分析和解决中学数学学科中的教育教学问题。</textarea>
                            </div>

                        </div>
                    </div>

                </div>

                <div class="flex justify-end mt-8 space-x-4">
                    <button id="add-objective" class="border border-gray-300 text-gray-700 px-6 py-3 rounded-md hover:bg-gray-50 transition-colors">
                        添加课程目标
                    </button>
                    <button id="to-step-2" class="bg-primary text-white px-6 py-3 rounded-md hover:bg-primary/90 transition-colors">
                        下一步：权重与达成度设置
                    </button>
                </div>
            </div>
        </div>

        <!-- 步骤2：权重与达成度设置 -->
        <div class="step-content hidden" id="step-2">
            <div class="bg-white rounded-lg p-6 card-shadow mb-8">
                <h2 class="text-xl font-semibold mb-4">权重设置</h2>
                
                <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-md">
                    <h3 class="text-lg font-semibold mb-4">全局成绩占比设置</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-gray-700 mb-2">期末成绩总占比（%）</label>
                            <input type="number" id="global-exam-percentage" class="w-full px-4 py-2 border-2 border-red-500 rounded-md form-input-focus" value="60" min="0" max="100">
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-2">平时成绩总占比（%）</label>
                            <input type="number" id="global-daily-percentage" class="w-full px-4 py-2 border-2 border-red-500 rounded-md form-input-focus" value="40" min="0" max="100">
                        </div>
                    </div>
                <p class="mt-2 text-sm text-gray-600">注：期末成绩占比和平时成绩占比之和应为100%</p>
            </div>
            
            <!-- 期末考试设置 -->
            <div class="mb-6 p-4 bg-green-50 border border-green-200 rounded-md">
                <h3 class="text-lg font-semibold mb-4">期末考试设置</h3>
                <p class="text-gray-600 mb-4">请设置期末考试每小题的总分，这些设置将用于下面课程目标的计算</p>
                <div class="flex justify-between items-center mb-2">
                    <p class="text-gray-600">期末考试题目设置</p>
                    <button type="button" id="add-exam-question-global" class="text-primary hover:text-primary/80 text-sm">
                        + 增加题目
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">题目</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">总分</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="global-exam-items">
                            <tr>
                                <td class="px-4 py-2"><span class="global-question-name font-medium">第1题</span></td>
                                <td class="px-4 py-2"><input type="number" class="w-full px-3 py-2 border-2 border-red-500 rounded-md global-question-score" value="20"></td>
                                <td class="px-4 py-2"><button type="button" class="delete-global-question-btn text-red-500 hover:text-red-600 text-sm">删除</button></td>
                            </tr>
                            <tr>
                                <td class="px-4 py-2"><span class="global-question-name font-medium">第2题</span></td>
                                <td class="px-4 py-2"><input type="number" class="w-full px-3 py-2 border-2 border-red-500 rounded-md global-question-score" value="10"></td>
                                <td class="px-4 py-2"><button type="button" class="delete-global-question-btn text-red-500 hover:text-red-600 text-sm">删除</button></td>
                            </tr>
                            <tr>
                                <td class="px-4 py-2"><span class="global-question-name font-medium">第3题</span></td>
                                <td class="px-4 py-2"><input type="number" class="w-full px-3 py-2 border-2 border-red-500 rounded-md global-question-score" value="10"></td>
                                <td class="px-4 py-2"><button type="button" class="delete-global-question-btn text-red-500 hover:text-red-600 text-sm">删除</button></td>
                            </tr>
                            <tr>
                                <td class="px-4 py-2"><span class="global-question-name font-medium">第4题</span></td>
                                <td class="px-4 py-2"><input type="number" class="w-full px-3 py-2 border-2 border-red-500 rounded-md global-question-score" value="60"></td>
                                <td class="px-4 py-2"><button type="button" class="delete-global-question-btn text-red-500 hover:text-red-600 text-sm">删除</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- 课程目标容器 - 横排布局，一排3个 -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8" id="objectives-container">
            <!-- 课程目标1 -->
                <div class="mb-0 border border-gray-200 rounded-md p-6">
                    <h3 class="text-lg font-semibold mb-4">课程目标1</h3>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">平时成绩占比（%）</label>
                        <input type="number" id="objective-1-daily-percentage" class="w-full px-4 py-2 border-2 border-red-500 rounded-md form-input-focus" value="12.5" min="0" max="100">
                    </div>
                    
                    <div>
                        <h4 class="font-medium mb-2">期末成绩题目设置</h4>
                        <div class="flex justify-between items-center mb-2">
                            <p class="text-gray-600">请输入期末每一个小题的占比（总分已从期末考试设置中同步）</p>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">题目</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">总分</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">占比（%）</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200" id="objective-1-exam-items">
                                    <tr>
                                        <td class="px-4 py-2"><input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md question-name" value="第一题" readonly></td>
                                        <td class="px-4 py-2"><input type="number" class="w-full px-3 py-2 border border-gray-300 rounded-md question-score" data-question="第一题" value="20" readonly></td>
                                        <td class="px-4 py-2"><input type="number" class="w-full px-3 py-2 border-2 border-red-500 rounded-md" value="80"></td>
                                    </tr>
                                    <tr>
                                        <td class="px-4 py-2"><input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md question-name" value="第二题" readonly></td>
                                        <td class="px-4 py-2"><input type="number" class="w-full px-3 py-2 border border-gray-300 rounded-md question-score" data-question="第二题" value="10" readonly></td>
                                        <td class="px-4 py-2"><input type="number" class="w-full px-3 py-2 border-2 border-red-500 rounded-md" value="90"></td>
                                    </tr>
                                    <tr>
                                        <td class="px-4 py-2"><input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md question-name" value="第三题" readonly></td>
                                        <td class="px-4 py-2"><input type="number" class="w-full px-3 py-2 border border-gray-300 rounded-md question-score" data-question="第三题" value="10" readonly></td>
                                        <td class="px-4 py-2"><input type="number" class="w-full px-3 py-2 border-2 border-red-500 rounded-md" value="80"></td>
                                    </tr>
                                    <tr>
                                        <td class="px-4 py-2"><input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md question-name" value="第四题" readonly></td>
                                        <td class="px-4 py-2"><input type="number" class="w-full px-3 py-2 border border-gray-300 rounded-md question-score" data-question="第四题" value="60" readonly></td>
                                        <td class="px-4 py-2"><input type="number" class="w-full px-3 py-2 border-2 border-red-500 rounded-md" value="70"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
                
                <!-- 课程目标2 -->
                <div class="mb-0 border border-gray-200 rounded-md p-6">
                    <h3 class="text-lg font-semibold mb-4">课程目标2</h3>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">平时成绩占比（%）</label>
                        <input type="number" id="objective-2-daily-percentage" class="w-full px-4 py-2 border-2 border-red-500 rounded-md form-input-focus" value="42.5" min="0" max="100">
                    </div>
                    
                    <div>
                        <h4 class="font-medium mb-2">期末成绩题目设置</h4>
                        <div class="flex justify-between items-center mb-2">
                            <p class="text-gray-600">请输入期末每一个小题的占比（总分已从期末考试设置中同步）</p>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">题目</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">总分</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">占比（%）</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200" id="objective-2-exam-items">
                                    <tr>
                                        <td class="px-4 py-2"><input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md question-name" value="第一题" readonly></td>
                                        <td class="px-4 py-2"><input type="number" class="w-full px-3 py-2 border border-gray-300 rounded-md question-score" data-question="第一题" value="20" readonly></td>
                                        <td class="px-4 py-2"><input type="number" class="w-full px-3 py-2 border-2 border-red-500 rounded-md" value="0"></td>
                                    </tr>
                                    <tr>
                                        <td class="px-4 py-2"><input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md question-name" value="第二题" readonly></td>
                                        <td class="px-4 py-2"><input type="number" class="w-full px-3 py-2 border border-gray-300 rounded-md question-score" data-question="第二题" value="10" readonly></td>
                                        <td class="px-4 py-2"><input type="number" class="w-full px-3 py-2 border-2 border-red-500 rounded-md" value="0"></td>
                                    </tr>
                                    <tr>
                                        <td class="px-4 py-2"><input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md question-name" value="第三题" readonly></td>
                                        <td class="px-4 py-2"><input type="number" class="w-full px-3 py-2 border border-gray-300 rounded-md question-score" data-question="第三题" value="10" readonly></td>
                                        <td class="px-4 py-2"><input type="number" class="w-full px-3 py-2 border-2 border-red-500 rounded-md" value="0"></td>
                                    </tr>
                                    <tr>
                                        <td class="px-4 py-2"><input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md question-name" value="第四题" readonly></td>
                                        <td class="px-4 py-2"><input type="number" class="w-full px-3 py-2 border border-gray-300 rounded-md question-score" data-question="第四题" value="60" readonly></td>
                                        <td class="px-4 py-2"><input type="number" class="w-full px-3 py-2 border-2 border-red-500 rounded-md" value="0"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
                
                <!-- 课程目标3 -->
                <div class="mb-0 border border-gray-200 rounded-md p-6">
                    <h3 class="text-lg font-semibold mb-4">课程目标3</h3>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 mb-2">平时成绩占比（%）</label>
                        <input type="number" id="objective-3-daily-percentage" class="w-full px-4 py-2 border-2 border-red-500 rounded-md form-input-focus" value="45" min="0" max="100">
                    </div>
                    
                    <div>
                        <h4 class="font-medium mb-2">期末成绩题目设置</h4>
                        <div class="flex justify-between items-center mb-2">
                            <p class="text-gray-600">请输入期末每一个小题的占比（总分已从期末考试设置中同步）</p>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">题目</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">总分</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">占比（%）</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200" id="objective-3-exam-items">
                                    <tr>
                                        <td class="px-4 py-2"><input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md question-name" value="第一题" readonly></td>
                                        <td class="px-4 py-2"><input type="number" class="w-full px-3 py-2 border border-gray-300 rounded-md question-score" data-question="第一题" value="20" readonly></td>
                                        <td class="px-4 py-2"><input type="number" class="w-full px-3 py-2 border-2 border-red-500 rounded-md" value="20"></td>
                                    </tr>
                                    <tr>
                                        <td class="px-4 py-2"><input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md question-name" value="第二题" readonly></td>
                                        <td class="px-4 py-2"><input type="number" class="w-full px-3 py-2 border border-gray-300 rounded-md question-score" data-question="第二题" value="10" readonly></td>
                                        <td class="px-4 py-2"><input type="number" class="w-full px-3 py-2 border-2 border-red-500 rounded-md" value="10"></td>
                                    </tr>
                                    <tr>
                                        <td class="px-4 py-2"><input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md question-name" value="第三题" readonly></td>
                                        <td class="px-4 py-2"><input type="number" class="w-full px-3 py-2 border border-gray-300 rounded-md question-score" data-question="第三题" value="10" readonly></td>
                                        <td class="px-4 py-2"><input type="number" class="w-full px-3 py-2 border-2 border-red-500 rounded-md" value="20"></td>
                                    </tr>
                                    <tr>
                                        <td class="px-4 py-2"><input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md question-name" value="第四题" readonly></td>
                                        <td class="px-4 py-2"><input type="number" class="w-full px-3 py-2 border border-gray-300 rounded-md question-score" data-question="第四题" value="60" readonly></td>
                                        <td class="px-4 py-2"><input type="number" class="w-full px-3 py-2 border-2 border-red-500 rounded-md" value="30"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>
            
                <!-- 占比和计算结果显示 -->
                <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-md">
                    <h3 class="text-lg font-semibold mb-4">占比和计算结果</h3>
                    <div class="flex flex-wrap items-center gap-6">
                        <div>
                            <p class="font-medium">平时成绩占比和:</p>
                            <p id="daily-percentage-sum" class="text-primary font-medium">0%</p>
                        </div>
                        <div id="exam-percentage-sums" class="flex flex-wrap items-center gap-6">
                            <!-- 考试题目占比和将通过JavaScript动态添加 -->
                        </div>
                    </div>
                    <p class="mt-2 text-sm text-red-600 font-medium">提示：所有占比和须为100%。</p>
                </div>

                <div class="flex justify-center mb-6">
                    <button id="calculate-weights-btn" class="bg-primary text-white px-6 py-3 rounded-md hover:bg-primary/90 transition-colors">
                        计算权重
                    </button>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">课程目标</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">对应毕业要求指标点</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">权重值</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="weight-results">
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap">课程目标1</td>
                                <td class="px-6 py-4 whitespace-nowrap">毕业要求4.2[M]</td>
                                <td class="px-6 py-4 whitespace-nowrap font-medium text-primary">0.325</td>
                            </tr>
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap">课程目标2</td>
                                <td class="px-6 py-4 whitespace-nowrap">培养目标6.1[M]</td>
                                <td class="px-6 py-4 whitespace-nowrap font-medium text-primary">0.35</td>
                            </tr>
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap">课程目标3</td>
                                <td class="px-6 py-4 whitespace-nowrap">培养目标8.1[M]</td>
                                <td class="px-6 py-4 whitespace-nowrap font-medium text-primary">0.325</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="flex justify-end mt-8">
                    <button id="back-to-step-1" class="border border-gray-300 text-gray-700 px-6 py-3 rounded-md hover:bg-gray-50 transition-colors">
                        返回上一步
                    </button>
                    <button id="to-step-3" class="bg-primary text-white px-6 py-3 rounded-md hover:bg-primary/90 transition-colors ml-4">
                        下一步：学生成绩录入
                    </button>
                </div>
            </div>
        </div>

        <!-- 步骤3：学生成绩录入 -->
        <div class="step-content hidden" id="step-3">
            <div class="bg-white rounded-lg p-6 card-shadow mb-8">
                <h2 class="text-xl font-semibold mb-4">学生成绩录入</h2>
                
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-4">成绩录入</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50" id="students-table-header">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">学生姓名</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">平时成绩</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">期末成绩</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="students-table-body">
                                <!-- 学生行将通过JavaScript动态添加 -->
                            </tbody>
                            <tfoot class="bg-gray-50" id="students-table-footer">
                                <tr>
                                    <td class="px-4 py-2 font-medium">平均分</td>
                                    <td class="px-4 py-2"><span class="daily-average">0.0</span></td>
                                    <td class="px-4 py-2"><span class="exam-average">0.0</span></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    <div class="flex justify-between mt-4">
                        <div class="space-x-4">
                            <button id="add-student" class="border border-gray-300 text-gray-700 px-6 py-3 rounded-md hover:bg-gray-50 transition-colors">
                                添加学生
                            </button>
                            <button id="import-students" class="border-2 border-red-500 text-gray-700 px-6 py-3 rounded-md hover:bg-gray-50 transition-colors">
                                导入模版
                            </button>
                            <a href="#" id="download-template" class="border-2 border-red-500 text-gray-700 px-6 py-3 rounded-md hover:bg-gray-50 transition-colors inline-block">
                                下载模板
                            </a>
                            <input type="file" id="student-file" accept=".csv" class="hidden">
                        </div>
                        <div class="space-x-4">
                            <button id="calculate-achievements" class="bg-primary text-white px-6 py-3 rounded-md hover:bg-primary/90 transition-colors">
                                计算达成度
                            </button>
                        </div>
                    </div>
                    <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-md">
                        <h4 class="font-medium mb-2 text-blue-800">操作提示</h4>
                        <p class="text-blue-700">1. 点击"下载模板"按钮，获取CSV格式的学生成绩模板。</p>
                        <p class="text-blue-700">2. 使用Excel或其他电子表格软件打开模板，填入学生姓名和成绩信息。</p>
                        <p class="text-blue-700">3. 填完后直接"保存"，不要"另存为xlsx格式"，确保文件格式保持为.csv。</p>
                        <p class="text-blue-700">4. 点击"导入模版"按钮，选择保存好的CSV文件完成数据导入。</p>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-4">计算达成度</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50" id="achievements-table-header">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">姓名</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">平时成绩</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">考试成绩</th>
                                    <!-- 课程目标达成度列将通过JavaScript动态添加 -->
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">总达成度</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="achievements-table-body">
                                <!-- 学生达成度行将通过JavaScript动态添加 -->
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-4 flex justify-center">
                        <button id="export-achievements" class="bg-primary text-white px-6 py-2 rounded-md hover:bg-primary/90 transition-colors">
                            导出达成度
                        </button>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-4">问卷调查</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">课程目标</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">课程目标达成情况相关问题</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">权重</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">完全达成</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">较好达成</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">基本达成</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">未达成</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">各课程目标达成度</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">课程目标达成度</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="questionnaire-table-body">
                                <!-- 问卷调查行将通过JavaScript动态添加 -->
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-4 flex justify-center">
                        <button id="calculate-questionnaire" class="bg-primary text-white px-6 py-2 rounded-md hover:bg-primary/90 transition-colors">
                            计算按钮
                        </button>
                    </div>
                </div>

                <div class="flex justify-end mt-8">
                    <button id="back-to-step-2" class="border border-gray-300 text-gray-700 px-6 py-3 rounded-md hover:bg-gray-50 transition-colors">
                        返回上一步
                    </button>
                    <button id="to-step-4" class="bg-primary text-white px-6 py-3 rounded-md hover:bg-primary/90 transition-colors ml-4">
                        下一步：课程目标达成分析
                    </button>
                </div>
            </div>
        </div>

        <!-- 步骤4：课程目标达成分析 -->
        <div class="step-content hidden" id="step-4">
            <div class="bg-white rounded-lg p-6 card-shadow mb-8">
                <h2 class="text-xl font-semibold mb-4">课程目标达成分析</h2>
                
                <div class="mb-8">
                    <p class="text-gray-600 mb-6">点击下方按钮生成课程目标达成评价报告，系统将根据之前录入的学生成绩和计算的达成度数据，自动生成完整的分析报告。</p>
                    
                    <!-- 支付提示 -->
                    <div class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-md" id="payment-prompt">
                        <h4 class="font-medium mb-2 text-yellow-800">付费提示</h4>
                        <p class="text-yellow-700" id="payment-message">嗨！感谢你的支持。我尊重自己的劳动成果，所以导出分析报告需要支付费用。你可以自由决定支付金额。请扫描下方二维码完成支付，支付完成后点击"生成分析报告"按钮。</p>
                    </div>
                    
                    <!-- 微信支付二维码 -->
                    <div class="flex flex-col items-center mb-6">
                        <div class="mb-2">
                            <img src="wechat-pay-qr.jpg" alt="微信支付二维码" class="w-48 h-48 border-2 border-gray-200 p-2">
                        </div>
                        <p class="text-sm text-gray-500 mb-4" id="qr-code-text">请扫描二维码完成支付（费用随心）</p>
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 mb-2">报告格式</label>
                            <select id="report-format" class="px-4 py-2 border border-gray-300 rounded-md form-input-focus">
                                <option value="word" selected>Word格式</option>
                            </select>
                        </div>
                        <button id="generate-report" class="bg-green-600 text-white px-8 py-4 rounded-md hover:bg-green-700 transition-colors text-lg font-medium">
                            生成分析报告
                        </button>
                        <p class="mt-4 text-gray-600 text-center">下载后，在"视图"中选择"页面"，即可正常查看。</p>
                    </div>
                </div>
                
                <div class="flex justify-end mt-8">
                    <button id="back-to-step-3" class="border border-gray-300 text-gray-700 px-6 py-3 rounded-md hover:bg-gray-50 transition-colors">
                        返回上一步
                    </button>
                </div>
            </div>
        </div>


    </main>

    <footer class="bg-white border-t border-gray-200 mt-8">
        <div class="container mx-auto px-4 py-6 text-center text-gray-600">
            <p>课程目标达成度分析报告生成系统 © 2024</p>
        </div>
    </footer>

    <!-- JavaScript -->
    <script>
        // 同步学生成绩录入表格的期末考试题目
            function syncStudentsTableExamItems() {
                var globalExamItems = document.getElementById('global-exam-items');
                if (!globalExamItems) return;
                
                var tableHeader = document.getElementById('students-table-header');
                var tableBody = document.getElementById('students-table-body');
                var tableFooter = document.getElementById('students-table-footer');
                if (!tableHeader || !tableBody || !tableFooter) return;
                
                // 获取现有的表头行和表尾行
                var headerRow = tableHeader.querySelector('tr');
                var footerRow = tableFooter.querySelector('tr');
                if (!headerRow || !footerRow) return;
                
                // 清空表头和表尾
                headerRow.innerHTML = '';
                footerRow.innerHTML = '';
                
                // 添加前三个表头：学生姓名、平时成绩、期末成绩
                var headers = ['学生姓名', '平时成绩', '期末成绩'];
                headers.forEach(function(headerText) {
                    var th = document.createElement('th');
                    th.className = 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                    th.textContent = headerText;
                    headerRow.appendChild(th);
                });
                
                // 添加期末考试题目表头（带总分）
                var globalRows = globalExamItems.querySelectorAll('tr');
                globalRows.forEach(function(row) {
                    var nameSpan = row.querySelector('.global-question-name');
                    var scoreInput = row.querySelector('.global-question-score');
                    if (nameSpan && scoreInput) {
                        var questionName = nameSpan.textContent;
                        var totalScore = scoreInput.value;
                        
                        // 添加表头
                        var th = document.createElement('th');
                        th.className = 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                        th.textContent = questionName + '（总分' + totalScore + '）';
                        headerRow.appendChild(th);
                    }
                });
                
                // 添加操作表头
                var actionTh = document.createElement('th');
                actionTh.className = 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                actionTh.textContent = '操作';
                headerRow.appendChild(actionTh);
                
                // 添加前三个表尾单元格：平均分、平时成绩平均分、期末成绩平均分
                var footerCells = ['平均分', '<span class="daily-average">0.0</span>', '<span class="exam-average">0.0</span>'];
                footerCells.forEach(function(cellContent, index) {
                    var td = document.createElement('td');
                    td.className = 'px-4 py-2';
                    if (index === 0) {
                        td.className += ' font-medium';
                        td.textContent = cellContent;
                    } else {
                        td.innerHTML = cellContent;
                    }
                    footerRow.appendChild(td);
                });
                
                // 添加期末考试题目表尾平均分单元格
                globalRows.forEach(function(row) {
                    var nameSpan = row.querySelector('.global-question-name');
                    var scoreInput = row.querySelector('.global-question-score');
                    if (nameSpan && scoreInput) {
                        var questionName = nameSpan.textContent;
                        
                        // 添加表尾平均分单元格
                        var td = document.createElement('td');
                        td.className = 'px-4 py-2';
                        var span = document.createElement('span');
                        span.className = 'question-average';
                        span.dataset.question = questionName;
                        span.textContent = '0.0';
                        td.appendChild(span);
                        footerRow.appendChild(td);
                    }
                });
                
                // 添加操作表尾单元格
                var actionTd = document.createElement('td');
                actionTd.className = 'px-4 py-2';
                footerRow.appendChild(actionTd);
                
                // 获取或创建学生行
                var studentRows = tableBody.querySelectorAll('tr');
                if (studentRows.length === 0) {
                    // 如果没有学生行，添加3个默认学生行
                    for (var i = 0; i < 3; i++) {
                        addStudentRow(tableBody, globalRows);
                    }
                    studentRows = tableBody.querySelectorAll('tr');
                }
                
                // 更新现有学生行
                studentRows.forEach(function(row) {
                    // 计算现有输入框数量
                    var existingInputs = row.querySelectorAll('input');
                    var existingInputCount = existingInputs.length;
                    
                    // 获取全局题目数量
                    var questionCount = globalRows.length;
                    
                    // 如果现有输入框数量不等于需要的数量，重建整个行
                    if (existingInputCount !== 3 + questionCount) {
                        rebuildStudentRow(row, globalRows);
                    }
                });
                
                // 重新添加事件监听器
                addStudentScoreListeners();
                
                // 重新计算平均分
                calculateAverages();
            }
        
        // 添加学生行
        function addStudentRow(tableBody, globalRows) {
            var newRow = document.createElement('tr');
            rebuildStudentRow(newRow, globalRows);
            tableBody.appendChild(newRow);
        }
        
        // 重建学生行
        function rebuildStudentRow(row, globalRows) {
            row.innerHTML = '';
            
            // 添加学生姓名输入框
            var nameCell = document.createElement('td');
            nameCell.className = 'px-4 py-2';
            var nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.className = 'w-full px-3 py-2 border border-gray-300 rounded-md';
            nameInput.placeholder = '学生姓名';
            nameCell.appendChild(nameInput);
            row.appendChild(nameCell);
            
            // 添加平时成绩输入框
            var dailyCell = document.createElement('td');
            dailyCell.className = 'px-4 py-2';
            var dailyInput = document.createElement('input');
            dailyInput.type = 'number';
            dailyInput.className = 'w-full px-3 py-2 border border-gray-300 rounded-md';
            dailyInput.min = '0';
            dailyInput.max = '100';
            dailyInput.value = '0';
            dailyCell.appendChild(dailyInput);
            row.appendChild(dailyCell);
            
            // 添加期末成绩输入框
            var examCell = document.createElement('td');
            examCell.className = 'px-4 py-2';
            var examInput = document.createElement('input');
            examInput.type = 'number';
            examInput.className = 'w-full px-3 py-2 border border-gray-300 rounded-md';
            examInput.min = '0';
            examInput.max = '100';
            examInput.value = '0';
            examCell.appendChild(examInput);
            row.appendChild(examCell);
            
            // 添加期末考试题目小分输入框
            globalRows.forEach(function(globalRow) {
                var nameSpan = globalRow.querySelector('.global-question-name');
                var scoreInput = globalRow.querySelector('.global-question-score');
                if (nameSpan && scoreInput) {
                    var questionName = nameSpan.textContent;
                    var totalScore = scoreInput.value;
                    var td = document.createElement('td');
                    td.className = 'px-4 py-2';
                    td.title = questionName + '，总分' + totalScore;
                    var input = document.createElement('input');
                    input.type = 'number';
                    input.className = 'w-full px-3 py-2 border border-gray-300 rounded-md';
                    input.min = '0';
                    input.max = totalScore;
                    input.value = '0';
                    td.appendChild(input);
                    row.appendChild(td);
                }
            });
            
            // 添加删除按钮
            var deleteCell = document.createElement('td');
            deleteCell.className = 'px-4 py-2';
            var deleteButton = document.createElement('button');
            deleteButton.className = 'bg-red-500 text-white px-3 py-1 rounded-md hover:bg-red-600 transition-colors delete-student';
            deleteButton.textContent = '删除';
            deleteButton.addEventListener('click', function() {
                row.remove();
                calculateAverages();
            });
            deleteCell.appendChild(deleteButton);
            row.appendChild(deleteCell);
        }
        
        // 同步所有课程目标的期末成绩题目设置
        function syncAllObjectivesExamItems() {
                var globalExamItems = document.getElementById('global-exam-items');
                if (!globalExamItems) {
                    return;
                }
                
                // 获取步骤2的内容
                var step2Content = document.getElementById('step-2');
                if (!step2Content) {
                    return;
                }
                
                // 查找所有课程目标权重设置部分
                var objectiveSections = [];
                
                // 首先查找grid容器中的课程目标
                var objectivesContainer = document.getElementById('objectives-container');
                if (objectivesContainer) {
                    var gridSections = objectivesContainer.querySelectorAll('.border.border-gray-200.rounded-md.p-6');
                    objectiveSections = Array.from(gridSections);
                }
                
                // 如果grid容器中没有找到，查找直接在step2Content下的课程目标
                if (objectiveSections.length === 0) {
                    var directSections = step2Content.querySelectorAll('.mb-8.border.border-gray-200.rounded-md.p-6');
                    objectiveSections = Array.from(directSections);
                }
                
                // 为每个课程目标同步期末成绩题目设置
                objectiveSections.forEach(function(section) {
                    // 查找期末成绩题目设置表格
                    var examItems = section.querySelector('[id$="-exam-items"]');
                    if (examItems) {
                        // 保存用户已输入的占比信息
                        var existingPercentages = {};
                        var existingRows = examItems.querySelectorAll('tr');
                        existingRows.forEach(function(row) {
                            var nameInput = row.querySelector('.question-name');
                            var percentageInput = row.querySelectorAll('input[type="number"]')[1];
                            if (nameInput && percentageInput && !percentageInput.hasAttribute('readonly')) {
                                var questionName = nameInput.value;
                                var percentage = percentageInput.value;
                                existingPercentages[questionName] = percentage;
                            }
                        });
                        
                        // 清空现有题目
                        examItems.innerHTML = '';
                        
                        // 填充全局期末考试设置中的题目
                        var globalRows = globalExamItems.querySelectorAll('tr');
                        globalRows.forEach(function(row) {
                            var nameSpan = row.querySelector('.global-question-name');
                            var scoreInput = row.querySelector('.global-question-score');
                            if (nameSpan && scoreInput) {
                                var name = nameSpan.textContent;
                                var score = scoreInput.value;
                                
                                // 保留用户之前输入的占比信息，如果没有则使用0
                                var percentage = existingPercentages[name] || '0';
                                
                                var newRow = document.createElement('tr');
                                newRow.innerHTML = '<td class="px-4 py-2"><input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md question-name" value="' + name + '" readonly></td>' +
                                    '<td class="px-4 py-2"><input type="number" class="w-full px-3 py-2 border border-gray-300 rounded-md question-score" data-question="' + name + '" value="' + score + '" readonly></td>' +
                                    '<td class="px-4 py-2"><input type="number" class="w-full px-3 py-2 border-2 border-red-500 rounded-md" value="' + percentage + '"></td>';
                                examItems.appendChild(newRow);
                            }
                        });
                    }
                });
                
                // 重新为所有相关输入框添加事件监听器，确保占比输入时能及时更新
                addAllInputListeners();
                
                // 重新计算占比和
                calculateAllPercentageSums();
            }

            // 页面加载完成后执行
            window.onload = function() {
                // 设置当前日期
                var currentDateElement = document.getElementById('current-date');
                var now = new Date();
                var options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
                currentDateElement.textContent = now.toLocaleDateString('zh-CN', options);
                
                // 同步所有课程目标的期末成绩题目设置
                syncAllObjectivesExamItems();
                
                // 初始化第三部分的学生成绩录入表格
                syncStudentsTableExamItems();
                
                // 同步达成度表格的表头
                syncAchievementsTableHeader();
                
                // 为所有输入框添加事件监听器
                addAllInputListeners();
                
                // 为全局成绩占比设置中的输入框添加事件监听器
                var globalExamPercentage = document.getElementById('global-exam-percentage');
                var globalDailyPercentage = document.getElementById('global-daily-percentage');
                if (globalExamPercentage) {
                    globalExamPercentage.addEventListener('change', function() {
                        if (typeof window.calculateWeights === 'function') {
                            window.calculateWeights();
                        }
                    });
                }
                if (globalDailyPercentage) {
                    globalDailyPercentage.addEventListener('change', function() {
                        if (typeof window.calculateWeights === 'function') {
                            window.calculateWeights();
                        }
                    });
                }
                
                // 为现有全局期末考试设置中的分数输入框添加事件监听器
                document.querySelectorAll('.global-question-score').forEach(function(input) {
                    input.addEventListener('change', function() {
                        // 直接调用同步函数，确保所有课程目标都与全局期末考试设置保持一致
                        syncAllObjectivesExamItems();
                        // 重新计算权重
                        if (typeof window.calculateWeights === 'function') {
                            window.calculateWeights();
                        }
                    });
                });
                
                // 为计算达成度按钮添加点击事件监听器
            var calculateAchievementsBtn = document.getElementById('calculate-achievements');
            console.log('calculateAchievementsBtn:', calculateAchievementsBtn);
            if (calculateAchievementsBtn) {
                calculateAchievementsBtn.addEventListener('click', function() {
                    console.log('计算达成度按钮被点击');
                    calculateAchievements();
                });
            } else {
                console.log('未找到计算达成度按钮');
            }
            
            // 为课程目标支撑指标点达成情况图表的导出按钮添加事件监听器
            var exportObjectivesChartBtn = document.getElementById('export-objectives-chart');
            if (exportObjectivesChartBtn) {
                exportObjectivesChartBtn.addEventListener('click', function() {
                    if (window.objectivesChart) {
                        exportChart(window.objectivesChart, '课程目标支撑指标点达成情况.png');
                    }
                });
            }
                
                // 为导入学生按钮添加点击事件监听器
                var importStudentsBtn = document.getElementById('import-students');
                var studentFileInput = document.getElementById('student-file');
                if (importStudentsBtn && studentFileInput) {
                    importStudentsBtn.addEventListener('click', function() {
                        studentFileInput.click();
                    });
                    
                    // 为文件输入添加change事件监听器
                    studentFileInput.addEventListener('change', function(e) {
                        var file = e.target.files[0];
                        if (file) {
                            importStudentsFromFile(file);
                        }
                    });
                }
                
                // 为下载模板按钮添加点击事件监听器
                var downloadTemplateBtn = document.getElementById('download-template');
                if (downloadTemplateBtn) {
                    downloadTemplateBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        downloadStudentTemplate();
                    });
                }
            };

            // 从CSV文件导入学生
            function importStudentsFromFile(file) {
                var reader = new FileReader();
                
                // 尝试使用多种编码读取文件
                function tryReadWithEncoding(encoding) {
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        var content = e.target.result;
                        
                        // 处理不同编码的BOM
                        if (content.charCodeAt(0) === 0xFEFF) {
                            // UTF-8 BOM
                            content = content.substring(1);
                        } else if (content.charCodeAt(0) === 0xFF && content.charCodeAt(1) === 0xFE) {
                            // UTF-16 LE BOM
                            content = content.substring(2);
                        } else if (content.charCodeAt(0) === 0xFE && content.charCodeAt(1) === 0xFF) {
                            // UTF-16 BE BOM
                            content = content.substring(2);
                        }
                        
                        // 处理可能的换行符差异
                        content = content.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
                        
                        var rows = content.split('\n');
                        var tableBody = document.getElementById('students-table-body');
                        var globalExamItems = document.getElementById('global-exam-items');
                        if (!tableBody || !globalExamItems) return;
                        
                        var globalRows = globalExamItems.querySelectorAll('tr');
                        
                        // 清空现有学生行
                        tableBody.innerHTML = '';
                        
                        // 遍历CSV行（跳过表头）
                        for (var i = 1; i < rows.length; i++) {
                            var row = rows[i].trim();
                            if (!row) continue;
                            
                            // 更智能的CSV解析，处理可能的逗号在引号内的情况
                            var cells = [];
                            var currentCell = '';
                            var inQuotes = false;
                            
                            for (var j = 0; j < row.length; j++) {
                                var char = row[j];
                                
                                if (char === '"') {
                                    inQuotes = !inQuotes;
                                } else if (char === ',' && !inQuotes) {
                                    cells.push(currentCell.trim());
                                    currentCell = '';
                                } else {
                                    currentCell += char;
                                }
                            }
                            
                            // 添加最后一个单元格
                            if (currentCell !== '') {
                                cells.push(currentCell.trim());
                            }
                            
                            if (cells.length < 3) continue;
                            
                            var name = cells[0];
                            var dailyScore = parseFloat(cells[1]) || 0;
                            var examScore = parseFloat(cells[2]) || 0;
                            
                            // 清理姓名中的可能的特殊字符
                            name = name.replace(/[\s\u00A0]+/g, ' ').trim();
                            
                            // 检查姓名是否可能是乱码（包含大量非ASCII字符但不是有效的中文）
                            var hasChineseChars = /[\u4e00-\u9fa5]/.test(name);
                            var hasManySpecialChars = (name.replace(/[\u0000-\u007F\u4e00-\u9fa5]/g, '').length / name.length) > 0.5;
                            
                            // 如果使用UTF-8编码但没有中文且有很多特殊字符，可能是编码错误
                            if (encoding === 'UTF-8' && !hasChineseChars && hasManySpecialChars) {
                                // 尝试使用GBK编码
                                tryReadWithEncoding('GBK');
                                return;
                            }
                            
                            // 创建学生行
                            var newRow = document.createElement('tr');
                            rebuildStudentRow(newRow, globalRows);
                            
                            // 填充学生数据
                            var inputs = newRow.querySelectorAll('input');
                            if (inputs.length >= 3) {
                                inputs[0].value = name;
                                inputs[1].value = dailyScore;
                                inputs[2].value = examScore;
                                
                                // 填充题目得分（如果有）
                                for (var j = 3; j < Math.min(inputs.length, cells.length); j++) {
                                    var score = parseFloat(cells[j]) || 0;
                                    inputs[j].value = score;
                                }
                            }
                            
                            tableBody.appendChild(newRow);
                        }
                        
                        // 重新添加事件监听器
                        addStudentScoreListeners();
                        
                        // 重新计算平均分
                        calculateAverages();
                    };
                    
                    reader.onerror = function() {
                        // 如果当前编码读取失败，尝试下一种编码
                        if (encoding === 'UTF-8') {
                            tryReadWithEncoding('GBK');
                        }
                    };
                    
                    reader.readAsText(file, encoding);
                }
                
                // 首先尝试UTF-8编码
                tryReadWithEncoding('UTF-8');
            }

            // 下载学生模板
            function downloadStudentTemplate() {
                var globalExamItems = document.getElementById('global-exam-items');
                var questionCount = 0;
                if (globalExamItems) {
                    questionCount = globalExamItems.querySelectorAll('tr').length;
                }
                
                // 创建CSV内容
                var csvContent = '学生姓名,平时成绩,期末成绩';
                for (var i = 1; i <= questionCount; i++) {
                    csvContent += ',第' + i + '题得分';
                }
                csvContent += '\n';
                
                // 添加示例数据
                csvContent += '张三,85,90';
                for (var i = 1; i <= questionCount; i++) {
                    csvContent += ',5';
                }
                csvContent += '\n';
                
                csvContent += '李四,92,88';
                for (var i = 1; i <= questionCount; i++) {
                    csvContent += ',4';
                }
                csvContent += '\n';
                
                // 创建Blob对象，添加UTF-8 BOM以确保Windows系统正确识别中文编码
                var bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
                var blob = new Blob([bom, csvContent], { type: 'text/csv;charset=utf-8;' });
                var url = URL.createObjectURL(blob);
                var link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', '学生成绩模板.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            // 步骤导航
            var stepButtons = document.getElementsByClassName('step-btn');
            var stepContents = document.getElementsByClassName('step-content');

            for (var i = 0; i < stepButtons.length; i++) {
                stepButtons[i].addEventListener('click', function() {
                    var step = this.getAttribute('data-step');
                    showStep(step);
                });
            }

            // 步骤切换函数
            function showStep(stepNumber) {
                // 转换为字符串
                var stepStr = stepNumber.toString();
                
                // 隐藏所有步骤
                for (var i = 0; i < stepContents.length; i++) {
                    stepContents[i].classList.add('hidden');
                }

                // 显示选中的步骤
                document.getElementById('step-' + stepStr).classList.remove('hidden');

                // 更新步骤按钮样式
                for (var i = 0; i < stepButtons.length; i++) {
                    var button = stepButtons[i];
                    var btnStep = button.getAttribute('data-step');
                    if (btnStep === stepStr) {
                        button.classList.add('text-primary', 'border-primary');
                        button.classList.remove('text-gray-500');
                    } else {
                        button.classList.remove('text-primary', 'border-primary');
                        button.classList.add('text-gray-500');
                    }
                }

                // 如果切换到步骤2，计算权重并同步所有课程目标的期末成绩题目设置
                if (stepStr === '2') {
                    // 同步所有课程目标的期末成绩题目设置
                    syncAllObjectivesExamItems();
                    
                    // 确保calculateWeights函数已经定义
                    if (typeof window.calculateWeights === 'function') {
                        window.calculateWeights();
                    } else {
                        console.log('calculateWeights函数尚未定义');
                    }
                    
                    // 计算占比和
                    calculateAllPercentageSums();
                }
                

            }

            // 从评价内容中提取权重配置
            function extractWeightsFromContent(content) {
                // 使用字符串方法匹配百分比值
                var weights = [];
                var startIndex = 0;
                var openParen, closeParen, percentSign;
                
                while ((openParen = content.indexOf('(', startIndex)) !== -1) {
                    closeParen = content.indexOf(')', openParen);
                    percentSign = content.indexOf('%', openParen);
                    
                    if (closeParen !== -1 && percentSign !== -1 && percentSign < closeParen) {
                        var numberStr = content.substring(openParen + 1, percentSign);
                        var number = parseInt(numberStr);
                        if (!isNaN(number)) {
                            weights.push(number / 100);
                        }
                    }
                    
                    startIndex = openParen + 1;
                }

                return weights;
            }

            // 验证期末成绩中相同小题的总占比是否为100%
            function validateExamScores() {
                // 存储每个小题的总占比
                var questionPercentages = {};
                
                // 遍历所有课程目标的期末成绩表格
                for (var objectiveNumber = 1; objectiveNumber <= 3; objectiveNumber++) {
                    var examItemsElement = document.getElementById('objective-' + objectiveNumber + '-exam-items');
                    if (examItemsElement) {
                        var examRows = examItemsElement.getElementsByTagName('tr');
                        for (var i = 0; i < examRows.length; i++) {
                            var row = examRows[i];
                            var nameInput = row.querySelector('.question-name');
                            var inputs = row.getElementsByTagName('input');
                            var percentageInput = null;
                            var inputCount = 0;
                            for (var j = 0; j < inputs.length; j++) {
                                if (inputs[j].type === 'number') {
                                    inputCount++;
                                    if (inputCount === 2) {
                                        percentageInput = inputs[j];
                                        break;
                                    }
                                }
                            }
                            
                            if (nameInput && percentageInput) {
                                var questionName = nameInput.value.trim();
                                var percentage = parseInt(percentageInput.value) || 0;
                                
                                if (questionName) {
                                    if (!questionPercentages[questionName]) {
                                        questionPercentages[questionName] = 0;
                                    }
                                    questionPercentages[questionName] += percentage;
                                }
                            }
                        }
                    }
                }
                
                // 检查每个小题的总占比是否为100%
                for (var questionName in questionPercentages) {
                    if (questionPercentages.hasOwnProperty(questionName)) {
                        var totalPercentage = questionPercentages[questionName];
                        if (totalPercentage !== 100) {

                            return false;
                        }
                    }
                }
                
                return true;
            }
            
            // 验证平时成绩课程目标占比相加是否为100%
            function validateDailyScores() {
                var totalPercentage = 0;
                
                // 遍历所有课程目标的平时成绩占比
                for (var objectiveNumber = 1; objectiveNumber <= 3; objectiveNumber++) {
                    var dailyPercentageElement = document.getElementById('objective-' + objectiveNumber + '-daily-percentage');
                    if (dailyPercentageElement) {
                        var percentage = parseInt(dailyPercentageElement.value) || 0;
                        totalPercentage += percentage;
                    }
                }
                
                // 检查总占比是否为100%
                if (totalPercentage !== 100) {

                    return false;
                }
                
                return true;
            }

            // 计算权重
            window.calculateWeights = function() {
                console.log('calculateWeights 函数被调用');
                var weightResultsBody = document.getElementById('weight-results');
                console.log('weightResultsBody:', weightResultsBody);
                if (!weightResultsBody) {
                    console.log('weightResultsBody 不存在');
                    return;
                }
                
                // 清空结果表格，确保每次点击都重新计算
                weightResultsBody.innerHTML = '';

                // 获取全局成绩占比设置
                var globalExamPercentageElement = document.getElementById('global-exam-percentage');
                var globalDailyPercentageElement = document.getElementById('global-daily-percentage');
                
                var globalExamPercentage = globalExamPercentageElement ? parseFloat(globalExamPercentageElement.value) || 60 : 60;
                var globalDailyPercentage = globalDailyPercentageElement ? parseFloat(globalDailyPercentageElement.value) || 40 : 40;
                
                console.log('全局期末成绩占比:', globalExamPercentage);
                console.log('全局平时成绩占比:', globalDailyPercentage);

                var objectives = [];
                var objectiveCount = document.querySelectorAll('.objective-item').length; // 动态获取课程目标数量
                var rawWeights = [];
                var totalRawWeight = 0;

                for (var objectiveNumber = 1; objectiveNumber <= objectiveCount; objectiveNumber++) {
                    // 获取对应毕业要求指标点
                    var requirementElement = document.getElementById('objective-' + objectiveNumber + '-requirement');
                    var requirement = requirementElement ? requirementElement.value : '课程目标' + objectiveNumber;
                    
                    // 获取用户输入的平时成绩占比（百分比值）
                    var dailyPercentage = 0;
                    var dailyPercentageElement = document.getElementById('objective-' + objectiveNumber + '-daily-percentage');
                    if (dailyPercentageElement) {
                        dailyPercentage = parseFloat(dailyPercentageElement.value) || 0;
                    }
                    
                    // 计算目标权重：使用用户要求的公式
                    // 课程目标权重=（（（课程目标期末成绩题目每一小题分数*占比）*全局成绩期末成绩占比）+（课程目标平时成绩100*占比）*全局平时成绩占比）/100
                    
                    // 计算期末题目得分总和：Σ(题目分数×占比/100)
                    var examTotalScore = 0;
                    var examItemsElement = document.getElementById('objective-' + objectiveNumber + '-exam-items');
                    if (examItemsElement) {
                        var scoreRows = examItemsElement.getElementsByTagName('tr');
                        for (var k = 0; k < scoreRows.length; k++) {
                            var row = scoreRows[k];
                            var scoreInput = row.querySelector('.question-score');
                            var percentageInput = row.querySelectorAll('input[type="number"]')[1];
                            
                            if (scoreInput && percentageInput) {
                                var score = parseFloat(scoreInput.value) || 0;
                                var percentage = parseFloat(percentageInput.value) || 0;
                                var questionScore = score * (percentage / 100); // 占比转换为小数
                                examTotalScore += questionScore;
                                console.log('课程目标' + objectiveNumber + '题目' + (k + 1) + '得分:', questionScore);
                            }
                        }
                    }
                    console.log('课程目标' + objectiveNumber + '期末题目得分总和:', examTotalScore);
                    
                    // 计算平时成绩部分：100×平时成绩占比/100
                    var dailyScore = 100 * (dailyPercentage / 100); // 100×平时成绩占比/100
                    console.log('课程目标' + objectiveNumber + '平时成绩得分:', dailyScore);
                    
                    // 计算总得分：（期末总得分×全局期末成绩占比） + （平时成绩得分×全局平时成绩占比）
                    var totalScore = (examTotalScore * (globalExamPercentage / 100)) + (dailyScore * (globalDailyPercentage / 100));
                    console.log('课程目标' + objectiveNumber + '总得分:', totalScore);
                    
                    // 计算权重：总得分÷100
                    var rawWeight = totalScore / 100;
                    console.log('课程目标' + objectiveNumber + '计算权重:', rawWeight);
                    
                    rawWeights.push(rawWeight);
                    totalRawWeight += rawWeight;
                    
                    // 保存计算结果
                    objectives.push({ 
                        rawWeight: rawWeight, 
                        requirement: requirement
                    });
                }

                // 直接使用计算得到的权重，不进行归一化
                for (var i = 0; i < objectives.length; i++) {
                    var objective = objectives[i];
                    var weight = objective.rawWeight;
                    
                    // 更新权重值
                    objective.weight = weight;
                    delete objective.rawWeight;
                    
                    // 更新权重结果表格
                    var row = document.createElement('tr');
                    row.innerHTML = '<td class="px-6 py-4 whitespace-nowrap">课程目标' + (i + 1) + '</td><td class="px-6 py-4 whitespace-nowrap">' + objective.requirement + '</td><td class="px-6 py-4 whitespace-nowrap font-medium text-primary">' + weight.toFixed(3) + '</td>';
                    weightResultsBody.appendChild(row);
                }

                // 保存计算得到的权重
                window.calculatedObjectives = objectives;
                console.log('权重计算完成，结果：', objectives);

            }

            // 计算所有课程目标的平时成绩占比之和
            function calculateDailyPercentageSum() {
                var totalPercentage = 0;
                
                // 遍历所有课程目标的平时成绩占比
                // 只选择ID以"objective-"开头且以"-daily-percentage"结尾的输入框，确保只计算课程目标中的占比
                var dailyPercentageInputs = document.querySelectorAll('[id^="objective-"][id$="-daily-percentage"]');
                dailyPercentageInputs.forEach(function(input) {
                    var percentage = parseFloat(input.value) || 0;
                    totalPercentage += percentage;
                });
                
                // 更新显示
                var dailyPercentageSumElement = document.getElementById('daily-percentage-sum');
                if (dailyPercentageSumElement) {
                    dailyPercentageSumElement.textContent = totalPercentage.toFixed(2) + '%';
                }
                
                return totalPercentage;
            }
            
            // 标准化题目名称，将"第一题"转换为"第1题"，"第二题"转换为"第2题"等
            function normalizeQuestionName(name) {
                // 替换汉字数字为阿拉伯数字
                var chineseNumbers = {'一': '1', '二': '2', '三': '3', '四': '4', '五': '5', '六': '6', '七': '7', '八': '8', '九': '9'};
                var normalizedName = name;
                
                for (var chineseNum in chineseNumbers) {
                    if (chineseNumbers.hasOwnProperty(chineseNum)) {
                        normalizedName = normalizedName.replace(new RegExp(chineseNum, 'g'), chineseNumbers[chineseNum]);
                    }
                }
                
                return normalizedName;
            }
            
            // 计算每个考试题目的占比之和
            function calculateExamPercentageSums() {
                // 获取全局期末考试题目
                var globalExamItems = document.getElementById('global-exam-items');
                if (!globalExamItems) return;
                
                var globalRows = globalExamItems.querySelectorAll('tr');
                var questionCount = globalRows.length;
                
                // 初始化每个题目的占比和
                var examPercentageSums = {};
                var normalizedToOriginal = {}; // 存储标准化名称到原始名称的映射
                
                for (var i = 0; i < questionCount; i++) {
                    var nameSpan = globalRows[i].querySelector('.global-question-name');
                    if (nameSpan) {
                        var questionName = nameSpan.textContent;
                        var normalizedName = normalizeQuestionName(questionName);
                        examPercentageSums[normalizedName] = 0;
                        normalizedToOriginal[normalizedName] = questionName;
                    }
                }
                
                // 遍历所有课程目标的期末考试题目设置
                // 只选择ID以"objective-"开头且以"-exam-items"结尾的表格，确保只计算课程目标中的占比
                var examItemsTables = document.querySelectorAll('[id^="objective-"][id$="-exam-items"]');
                examItemsTables.forEach(function(tableBody) {
                    var rows = tableBody.querySelectorAll('tr');
                    rows.forEach(function(row) {
                        var nameInput = row.querySelector('.question-name');
                        var percentageInput = row.querySelectorAll('input[type="number"]')[1];
                        
                        if (nameInput && percentageInput && !percentageInput.hasAttribute('readonly')) {
                            var questionName = nameInput.value;
                            var normalizedName = normalizeQuestionName(questionName);
                            var percentage = parseFloat(percentageInput.value) || 0;
                            
                            if (examPercentageSums.hasOwnProperty(normalizedName)) {
                                examPercentageSums[normalizedName] += percentage;
                            }
                        }
                    });
                });
                
                // 更新显示
                var examPercentageSumsElement = document.getElementById('exam-percentage-sums');
                if (examPercentageSumsElement) {
                    examPercentageSumsElement.innerHTML = '';
                    
                    for (var normalizedName in examPercentageSums) {
                        if (examPercentageSums.hasOwnProperty(normalizedName)) {
                            var sum = examPercentageSums[normalizedName];
                            var originalName = normalizedToOriginal[normalizedName] || normalizedName;
                            var div = document.createElement('div');
                            div.className = 'flex flex-col';
                            div.innerHTML = `
                                <p class="font-medium">${originalName}占比和:</p>
                                <p class="text-primary font-medium">${sum.toFixed(2)}%</p>
                            `;
                            examPercentageSumsElement.appendChild(div);
                        }
                    }
                }
                
                return examPercentageSums;
            }
            
            // 计算所有占比和
            function calculateAllPercentageSums() {
                calculateDailyPercentageSum();
                calculateExamPercentageSums();
            }
            
            // 步骤导航按钮事件
            document.getElementById('to-step-2').addEventListener('click', function() {
                showStep(2);
            });




            // 全局期末考试设置 - 增加题目按钮事件
            document.getElementById('add-exam-question-global').addEventListener('click', function() {
                var tbody = document.getElementById('global-exam-items');
                var newRow = document.createElement('tr');
                var rowCount = tbody.children.length;
                var questionNumber = rowCount + 1;
                
                newRow.innerHTML = `
                    <td class="px-4 py-2"><span class="global-question-name font-medium">第${questionNumber}题</span></td>
                    <td class="px-4 py-2"><input type="number" class="w-full px-3 py-2 border border-gray-300 rounded-md global-question-score" value="10"></td>
                    <td class="px-4 py-2"><button type="button" class="delete-global-question-btn text-red-500 hover:text-red-600 text-sm">删除</button></td>
                `;
                
                tbody.appendChild(newRow);
                
                // 为新添加的删除按钮添加事件监听器
                var deleteBtn = newRow.querySelector('.delete-global-question-btn');
                deleteBtn.addEventListener('click', function() {
                    var nameSpan = newRow.querySelector('.global-question-name');
                    var questionName = nameSpan ? nameSpan.textContent : '';
                    
                    // 从所有课程目标中删除相同的题目
                    var objectiveItems = document.querySelectorAll('[id^="objective-"]');
                    objectiveItems.forEach(function(item) {
                        var examItemsId = item.id.replace('-desc', '-exam-items').replace('-requirement', '-exam-items');
                        var examItems = document.getElementById(examItemsId);
                        if (examItems) {
                            var rows = examItems.querySelectorAll('tr');
                            rows.forEach(function(row) {
                                var nameInput = row.querySelector('.question-name');
                                if (nameInput && nameInput.value === questionName) {
                                    row.remove();
                                }
                            });
                        }
                    });
                    
                    newRow.remove();
                    
            // 更新剩余题目的编号
                    updateQuestionNumbers();
                    
                    // 同步更新第三步学生成绩录入表格
                    syncStudentsTableExamItems();
                    
                    // 计算平均分
                    calculateAverages();
                    
                    // 重新计算占比和
                    calculateAllPercentageSums();
                });
                
                // 为新添加的分数输入框添加事件监听器
                var scoreInput = newRow.querySelector('.global-question-score');
                var nameSpan = newRow.querySelector('.global-question-name');
                
                // 当分数变更时，更新所有课程目标中的对应题目
                function updateAllObjectives() {
                    // 直接调用同步函数，确保所有课程目标都与全局期末考试设置保持一致
                    syncAllObjectivesExamItems();
                }
                
                // 添加事件监听器
                scoreInput.addEventListener('change', updateAllObjectives);
                
                // 初始化时更新所有课程目标
                setTimeout(function() {
                    updateAllObjectives();
                    // 重新计算占比和
                    calculateAllPercentageSums();
                }, 100);
            });

            // 更新题目编号的函数
            function updateQuestionNumbers() {
                var globalExamItems = document.getElementById('global-exam-items');
                if (globalExamItems) {
                    var rows = globalExamItems.querySelectorAll('tr');
                    rows.forEach(function(row, index) {
                        var nameSpan = row.querySelector('.global-question-name');
                        if (nameSpan) {
                            nameSpan.textContent = `第${index + 1}题`;
                        }
                    });
                }
            }

            // 全局期末考试设置 - 为现有删除按钮添加事件监听器
            document.querySelectorAll('.delete-global-question-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var row = this.closest('tr');
                    var nameSpan = row.querySelector('.global-question-name');
                    var questionName = nameSpan ? nameSpan.textContent : '';
                    
                    // 从所有课程目标中删除相同的题目
                    var objectiveItems = document.querySelectorAll('[id^="objective-"]');
                    objectiveItems.forEach(function(item) {
                        var examItemsId = item.id.replace('-desc', '-exam-items').replace('-requirement', '-exam-items');
                        var examItems = document.getElementById(examItemsId);
                        if (examItems) {
                            var rows = examItems.querySelectorAll('tr');
                            rows.forEach(function(row) {
                                var nameInput = row.querySelector('.question-name');
                                if (nameInput && nameInput.value === questionName) {
                                    row.remove();
                                }
                            });
                        }
                    });
                    
                    row.remove();
                    
                    // 更新剩余题目的编号
                    updateQuestionNumbers();
                    
                    // 同步更新第三步学生成绩录入表格
                    syncStudentsTableExamItems();
                    
                    // 计算平均分
                    calculateAverages();
                    
                    // 重新计算占比和
                    calculateAllPercentageSums();
                });
            });

            // 为所有相关输入框添加事件监听器，确保用户输入时能及时更新页面
            function addAllInputListeners() {
                // 为全局成绩占比设置输入框添加事件监听器
                var globalExamPercentage = document.getElementById('global-exam-percentage');
                var globalDailyPercentage = document.getElementById('global-daily-percentage');
                
                if (globalExamPercentage) {
                    globalExamPercentage.addEventListener('input', function() {
                        console.log('全局期末成绩占比变化');
                        // 只更新占比和，不立即计算权重，避免卡顿
                        calculateAllPercentageSums();
                    });
                }
                
                if (globalDailyPercentage) {
                    globalDailyPercentage.addEventListener('input', function() {
                        console.log('全局平时成绩占比变化');
                        // 只更新占比和，不立即计算权重，避免卡顿
                        calculateAllPercentageSums();
                    });
                }
                
                // 为全局期末考试题目总分输入框添加事件监听器
                var globalQuestionScores = document.querySelectorAll('.global-question-score');
                globalQuestionScores.forEach(function(input) {
                    input.addEventListener('input', function() {
                        console.log('全局期末考试题目总分变化，同步更新所有课程目标');
                        syncAllObjectivesExamItems();
                        // 只同步题目，不立即计算权重，避免卡顿
                        calculateAllPercentageSums();
                    });
                });
                
                // 为所有课程目标的平时成绩占比输入框添加事件监听器
                var dailyPercentageInputs = document.querySelectorAll('[id^="objective-"][id$="-daily-percentage"]');
                console.log('找到平时成绩占比输入框数量:', dailyPercentageInputs.length);
                dailyPercentageInputs.forEach(function(input) {
                    // 直接添加事件监听器，避免克隆元素
                    input.addEventListener('input', function() {
                        console.log('平时成绩占比变化');
                        // 只更新占比和，不立即计算权重，避免卡顿
                        calculateAllPercentageSums();
                    });
                });

                // 为所有课程目标的期末成绩题目占比输入框添加事件监听器
                var examItemsTables = document.querySelectorAll('[id^="objective-"][id$="-exam-items"]');
                console.log('找到期末成绩题目表格数量:', examItemsTables.length);
                examItemsTables.forEach(function(tableBody) {
                    var percentageInputs = tableBody.querySelectorAll('input[type="number"]');
                    console.log('表格中找到输入框数量:', percentageInputs.length);
                    percentageInputs.forEach(function(input) {
                        // 跳过只读的分数输入框，只监听占比输入框
                        if (!input.hasAttribute('readonly')) {
                            // 直接添加事件监听器，避免克隆元素
                            input.addEventListener('input', function() {
                                console.log('期末成绩题目占比变化');
                                // 只更新占比和，不立即计算权重，避免卡顿
                                calculateAllPercentageSums();
                            });
                        }
                    });
                });
            }

            // 当添加新的课程目标时，也需要为新的输入框添加事件监听器
            // 事件监听器已在其他位置添加

            // 为计算权重按钮添加点击事件监听器
            document.getElementById('calculate-weights-btn').addEventListener('click', function() {
                console.log('计算权重按钮被点击');
                // 触发所有必要的计算
                if (typeof window.calculateWeights === 'function') {
                    window.calculateWeights();
                } else {
                    console.log('calculateWeights函数尚未定义');
                }
                // 重新计算占比和
                calculateAllPercentageSums();
            });

            // 步骤导航按钮事件
            document.getElementById('to-step-3').addEventListener('click', function() {
                showStep(3);
            });

            document.getElementById('back-to-step-2').addEventListener('click', function() {
                showStep(2);
            });

            // 步骤4导航按钮事件
            document.getElementById('to-step-4').addEventListener('click', function() {
                showStep(4);
            });

            document.getElementById('back-to-step-3').addEventListener('click', function() {
                showStep(3);
            });

            // 添加学生
            document.getElementById('add-student').addEventListener('click', function() {
                var tableBody = document.getElementById('students-table-body');
                var globalExamItems = document.getElementById('global-exam-items');
                if (!tableBody || !globalExamItems) return;
                
                var globalRows = globalExamItems.querySelectorAll('tr');
                addStudentRow(tableBody, globalRows);
            });

            // 当切换到步骤3时，同步期末考试题目
                var originalShowStep = showStep;
                showStep = function(stepNumber) {
                    originalShowStep(stepNumber);
                    
                    if (stepNumber === 2) {
                        // 为所有相关输入框添加事件监听器
                        addAllInputListeners();
                    }
                    
                    if (stepNumber === 3) {
                        syncStudentsTableExamItems();
                        syncAchievementsTableHeader();
                        calculateAverages();
                        addStudentScoreListeners();
                        generateQuestionnaireTable();
                    }
                };

            // 同步达成度表格的表头
            function syncAchievementsTableHeader() {
                var headerRow = document.querySelector('#achievements-table-header tr');
                if (!headerRow) return;
                
                // 清空表头
                headerRow.innerHTML = '';
                
                // 添加姓名表头
                var nameTh = document.createElement('th');
                nameTh.className = 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                nameTh.textContent = '姓名';
                headerRow.appendChild(nameTh);
                
                // 添加平时成绩表头
                var dailyTh = document.createElement('th');
                dailyTh.className = 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                dailyTh.textContent = '平时成绩';
                headerRow.appendChild(dailyTh);
                
                // 添加考试成绩表头
                var examTh = document.createElement('th');
                examTh.className = 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                examTh.textContent = '考试成绩';
                headerRow.appendChild(examTh);
                
                // 添加课程目标达成度表头
                var objectiveCount = document.querySelectorAll('.objective-item').length;
                for (var i = 1; i <= objectiveCount; i++) {
                    var th = document.createElement('th');
                    th.className = 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                    th.textContent = '课程目标' + i + '达成度';
                    headerRow.appendChild(th);
                }
                
                // 添加总达成度表头
                var totalTh = document.createElement('th');
                totalTh.className = 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                totalTh.textContent = '总达成度';
                headerRow.appendChild(totalTh);
            }



            // 计算达成度
            function calculateAchievements() {
                console.log('calculateAchievements 函数被调用');
                var studentsTableBody = document.getElementById('students-table-body');
                var achievementsTableBody = document.getElementById('achievements-table-body');
                console.log('studentsTableBody:', studentsTableBody);
                console.log('achievementsTableBody:', achievementsTableBody);
                if (!studentsTableBody || !achievementsTableBody) {
                    console.log('缺少必要的表格元素');
                    return;
                }
                
                // 清空达成度表格
                achievementsTableBody.innerHTML = '';
                console.log('达成度表格已清空');
                
                
                // 获取课程目标数量
                var objectiveCount = document.querySelectorAll('.objective-item').length;
                console.log('课程目标数量:', objectiveCount);
                
                // 获取所有学生行
                var studentRows = studentsTableBody.querySelectorAll('tr');
                console.log('学生行数量:', studentRows.length);
                
                // 初始化总分变量，用于计算平均分
                var totalDaily = 0;
                var totalExam = 0;
                var totalObjectives = new Array(objectiveCount).fill(0);
                var totalOverall = 0;
                var studentCount = 0;
                
                // 遍历每个学生
                studentRows.forEach(function(studentRow, index) {
                    console.log('处理学生行:', index + 1);
                    
                    var inputs = studentRow.querySelectorAll('input');
                    if (inputs.length < 3) return;
                    
                    // 获取学生姓名、平时成绩和期末成绩
                    var name = inputs[0].value || '未命名';
                    var dailyScore = parseFloat(inputs[1].value) || 0;
                    var examScore = parseFloat(inputs[2].value) || 0;
                    
                    // 创建达成度表格行
                    var achievementRow = document.createElement('tr');
                    
                    // 添加姓名、平时成绩和考试成绩单元格
                    var nameCell = document.createElement('td');
                    nameCell.className = 'px-4 py-2';
                    nameCell.textContent = name;
                    achievementRow.appendChild(nameCell);
                    
                    var dailyCell = document.createElement('td');
                    dailyCell.className = 'px-4 py-2';
                    dailyCell.textContent = Math.round(dailyScore);
                    achievementRow.appendChild(dailyCell);
                    
                    var examCell = document.createElement('td');
                    examCell.className = 'px-4 py-2';
                    examCell.textContent = Math.round(examScore);
                    achievementRow.appendChild(examCell);
                    
                    // 计算各课程目标达成度（按照第二步计算权重的方式）
                    var objectivesAchievements = [];
                    var totalAchievement = 0;
                    var totalWeight = 0;
                    
                    for (var i = 1; i <= objectiveCount; i++) {
                        // 获取课程目标的平时成绩占比
                        var dailyPercentageElement = document.getElementById('objective-' + i + '-daily-percentage');
                        var dailyPercentage = dailyPercentageElement ? parseFloat(dailyPercentageElement.value) / 100 : 0;
                        
                        // 获取全局成绩占比设置
                        var globalExamPercentageElement = document.getElementById('global-exam-percentage');
                        var globalDailyPercentageElement = document.getElementById('global-daily-percentage');
                        var globalExamPercentage = globalExamPercentageElement ? parseFloat(globalExamPercentageElement.value) / 100 : 0.6;
                        var globalDailyPercentage = globalDailyPercentageElement ? parseFloat(globalDailyPercentageElement.value) / 100 : 0.4;
                        
                        // 计算期末题目得分总和：Σ(题目得分×占比/100)
                        var examTotalScore = 0;
                        var examItemsElement = document.getElementById('objective-' + i + '-exam-items');
                        if (examItemsElement) {
                            var scoreRows = examItemsElement.querySelectorAll('tr');
                            scoreRows.forEach(function(row) {
                                var scoreInput = row.querySelector('.question-score');
                                var percentageInput = row.querySelectorAll('input[type="number"]')[1];
                                
                                if (scoreInput && percentageInput) {
                                    var score = parseFloat(scoreInput.value) || 0;
                                    var percentage = parseFloat(percentageInput.value) / 100 || 0;
                                    // 获取学生的对应题目得分
                                    var questionName = scoreInput.dataset.question;
                                    var studentQuestionScore = 0;
                                    
                                    // 遍历学生输入的题目得分
                                    var questionInputs = Array.from(inputs).slice(3);
                                    var globalExamItems = document.getElementById('global-exam-items');
                                    if (globalExamItems) {
                                        var globalRows = globalExamItems.querySelectorAll('tr');
                                        globalRows.forEach(function(globalRow, qIndex) {
                                            var nameSpan = globalRow.querySelector('.global-question-name');
                                            if (nameSpan && nameSpan.textContent === questionName && questionInputs[qIndex]) {
                                                studentQuestionScore = parseFloat(questionInputs[qIndex].value) || 0;
                                            }
                                        });
                                    }
                                    
                                    var questionScore = studentQuestionScore * percentage;
                                    examTotalScore += questionScore;
                                }
                            });
                        }
                        
                        // 计算平时成绩部分：100×平时成绩占比/100
                        var dailyScorePart = dailyScore * dailyPercentage;
                        
                        // 计算总得分：（期末总得分×全局期末成绩占比） + （平时成绩得分×全局平时成绩占比）
                        var totalScore = (examTotalScore * globalExamPercentage) + (dailyScorePart * globalDailyPercentage);
                        
                        // 获取课程目标权重
                        var weight = 1; // 默认权重为1
                        if (window.calculatedObjectives && window.calculatedObjectives[i-1]) {
                            weight = window.calculatedObjectives[i-1].weight || 1;
                        }
                        
                        // 计算课程目标达成度：总得分 / (权重×100)
                        var objectiveAchievement = weight > 0 ? totalScore / (weight * 100) : 0;
                        
                        objectivesAchievements.push(objectiveAchievement);
                        totalAchievement += objectiveAchievement * weight;
                        totalWeight += weight;
                        
                        // 添加课程目标达成度单元格
                        var objectiveCell = document.createElement('td');
                        objectiveCell.className = 'px-4 py-2';
                        objectiveCell.textContent = objectiveAchievement.toFixed(3);
                        achievementRow.appendChild(objectiveCell);
                    }
                    
                    // 计算总达成度（加权平均）
                    var weightedAchievement = totalWeight > 0 ? totalAchievement / totalWeight : 0;
                    
                    // 添加总达成度单元格
                    var totalCell = document.createElement('td');
                    totalCell.className = 'px-4 py-2 font-medium';
                    totalCell.textContent = weightedAchievement.toFixed(3);
                    achievementRow.appendChild(totalCell);
                    
                    // 添加到达成度表格
                    achievementsTableBody.appendChild(achievementRow);
                    
                    // 累积总分，用于计算平均分
                    totalDaily += dailyScore;
                    totalExam += examScore;
                    objectivesAchievements.forEach(function(achievement, index) {
                        totalObjectives[index] += achievement;
                    });
                    totalOverall += weightedAchievement;
                    studentCount++;
                });
                
                // 添加平均分行
                if (studentCount > 0) {
                    var averageRow = document.createElement('tr');
                    averageRow.className = 'bg-gray-50 font-medium';
                    
                    // 添加姓名单元格（显示"课程目标达成情况"）
                    var avgNameCell = document.createElement('td');
                    avgNameCell.className = 'px-4 py-2';
                    avgNameCell.textContent = '课程目标达成情况';
                    averageRow.appendChild(avgNameCell);
                    
                    // 添加空白单元格（平时成绩和考试成绩的平均分在之前的模块中已经计算过）
                    var emptyCell1 = document.createElement('td');
                    emptyCell1.className = 'px-4 py-2';
                    averageRow.appendChild(emptyCell1);
                    
                    var emptyCell2 = document.createElement('td');
                    emptyCell2.className = 'px-4 py-2';
                    averageRow.appendChild(emptyCell2);
                    
                    // 添加各课程目标达成度平均分单元格
                    totalObjectives.forEach(function(total, index) {
                        var avgObjectiveCell = document.createElement('td');
                        avgObjectiveCell.className = 'px-4 py-2';
                        avgObjectiveCell.textContent = (total / studentCount).toFixed(3);
                        averageRow.appendChild(avgObjectiveCell);
                    });
                    
                    // 添加总达成度平均分单元格
                    var avgOverallCell = document.createElement('td');
                    avgOverallCell.className = 'px-4 py-2';
                    avgOverallCell.textContent = (totalOverall / studentCount).toFixed(3);
                    averageRow.appendChild(avgOverallCell);
                    
                    // 添加平均分行到达成度表格
                    achievementsTableBody.appendChild(averageRow);
                }
                
                // 生成问卷调查表格
                generateQuestionnaireTable();
            }

            // 生成课程目标支撑指标点达成情况图表
            function generateObjectivesChart() {
                console.log('generateObjectivesChart 函数被调用');
                
                // 确保DOM元素存在
                var ctx = document.getElementById('objectives-chart');
                if (!ctx) {
                    console.log('未找到 objectives-chart 元素');
                    return;
                }
                
                // 确保Chart.js库已加载
                if (typeof Chart === 'undefined') {
                    console.log('Chart.js 库未加载');
                    return;
                }
                
                // 获取课程目标数量
                var objectiveCount = document.querySelectorAll('.objective-item').length;
                if (objectiveCount === 0) {
                    console.log('课程目标数量为0');
                    return;
                }
                
                // 计算各课程目标的平均达成度
                var objectiveAverages = [];
                var objectiveLabels = [];
                
                // 获取达成度表格中的平均行
                var achievementsTableBody = document.getElementById('achievements-table-body');
                if (!achievementsTableBody) {
                    console.log('未找到 achievements-table-body 元素');
                    return;
                }
                
                var averageRow = achievementsTableBody.querySelector('tr.bg-gray-50');
                if (!averageRow) {
                    console.log('未找到平均行');
                    return;
                }
                
                var cells = averageRow.querySelectorAll('td');
                if (cells.length < 3 + objectiveCount + 1) {
                    console.log('单元格数量不足');
                    return;
                }
                
                // 提取各课程目标的达成度数据
                for (var i = 3; i < 3 + objectiveCount; i++) {
                    var achievement = parseFloat(cells[i].textContent) || 0;
                    objectiveAverages.push(achievement);
                    objectiveLabels.push('课程目标' + (i - 2));
                }
                
                console.log('课程目标标签:', objectiveLabels);
                console.log('课程目标达成度:', objectiveAverages);
                
                // 生成期望值数据（0.7）
                var expectationValues = Array(objectiveCount).fill(0.7);
                
                // 销毁现有图表（如果存在）
                if (window.objectivesChart) {
                    window.objectivesChart.destroy();
                }
                
                // 创建新图表
                try {
                    window.objectivesChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: objectiveLabels,
                            datasets: [{
                                label: '达成度',
                                data: objectiveAverages,
                                backgroundColor: 'rgba(59, 130, 246, 0.8)',
                                borderColor: 'rgba(59, 130, 246, 1)',
                                borderWidth: 2
                            }, {
                                label: '期望值',
                                data: expectationValues,
                                type: 'line',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                backgroundColor: 'transparent',
                                pointRadius: 0,
                                fill: false
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                title: {
                                    display: false
                                },
                                legend: {
                                    display: true,
                                    position: 'top'
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return context.dataset.label + ': ' + context.parsed.y.toFixed(2);
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 1,
                                    ticks: {
                                        stepSize: 0.1,
                                        callback: function(value) {
                                            return value.toFixed(1);
                                        }
                                    }
                                }
                            }
                        }
                    });
                    console.log('图表创建成功');
                } catch (error) {
                    console.error('创建图表时出错:', error);
                }
            }
            
            // 导出图表为图片
            function exportChart(chart, filename) {
                if (!chart) return;
                
                try {
                    // 获取图表的base64图片
                    var image = chart.toBase64Image('image/png', 1.0);
                    
                    // 创建下载链接
                    var link = document.createElement('a');
                    link.download = filename;
                    link.href = image;
                    link.click();
                } catch (error) {
                    console.error('导出图表时出错:', error);
                }
            }
            
            // 存储个体图表实例
            window.individualCharts = [];
            
            // 生成个体对课程目标达成情况评价图
            function generateIndividualObjectivesCharts() {
                console.log('generateIndividualObjectivesCharts 函数被调用');
                
                // 确保DOM元素存在
                var chartsContainer = document.getElementById('individual-objectives-charts');
                if (!chartsContainer) {
                    console.log('未找到 individual-objectives-charts 元素');
                    return;
                }
                
                // 确保Chart.js库已加载
                if (typeof Chart === 'undefined') {
                    console.log('Chart.js 库未加载');
                    return;
                }
                
                // 获取课程目标数量
                var objectiveCount = document.querySelectorAll('.objective-item').length;
                if (objectiveCount === 0) {
                    console.log('课程目标数量为0');
                    return;
                }
                
                // 获取达成度表格
                var achievementsTableBody = document.getElementById('achievements-table-body');
                if (!achievementsTableBody) {
                    console.log('未找到 achievements-table-body 元素');
                    return;
                }
                
                // 获取学生行（排除平均行）
                var studentRows = achievementsTableBody.querySelectorAll('tr:not(.bg-gray-50)');
                if (studentRows.length === 0) {
                    console.log('学生行数量为0');
                    return;
                }
                
                // 收集每个课程目标的学生达成度数据
                var objectiveAchievements = [];
                for (var i = 0; i < objectiveCount; i++) {
                    objectiveAchievements.push([]);
                }
                
                // 遍历每个学生行
                studentRows.forEach(function(row) {
                    var cells = row.querySelectorAll('td');
                    if (cells.length < 3 + objectiveCount + 1) return;
                    
                    // 提取每个课程目标的达成度
                    for (var i = 0; i < objectiveCount; i++) {
                        var achievement = parseFloat(cells[i + 3].textContent) || 0;
                        objectiveAchievements[i].push(achievement);
                    }
                });
                
                // 清空容器
                chartsContainer.innerHTML = '';
                
                // 清空图表实例数组
                window.individualCharts = [];
                
                // 为每个课程目标生成折线图
                for (var i = 0; i < objectiveCount; i++) {
                    // 对达成度数据从小到大排序
                    var sortedAchievements = objectiveAchievements[i].sort(function(a, b) {
                        return a - b;
                    });
                    
                    // 生成人数作为横坐标
                    var labels = [];
                    for (var j = 1; j <= sortedAchievements.length; j++) {
                        labels.push(j.toString());
                    }
                    
                    // 创建图表容器
                    var chartWrapper = document.createElement('div');
                    chartWrapper.className = 'bg-white p-4 rounded-md shadow-sm';
                    chartWrapper.innerHTML = `
                        <h5 class="font-medium mb-4">课程目标${i + 1}达成情况</h5>
                        <div class="w-full h-64">
                            <canvas id="objective-${i + 1}-chart"></canvas>
                        </div>
                        <div class="mt-4 flex justify-center">
                            <button class="export-individual-chart bg-primary text-white px-6 py-2 rounded-md hover:bg-primary/90 transition-colors" data-objective="${i + 1}">
                                导出图
                            </button>
                        </div>
                    `;
                    chartsContainer.appendChild(chartWrapper);
                }
                
                // 等待所有DOM元素创建完成后再创建图表
                setTimeout(function() {
                    for (var i = 0; i < objectiveCount; i++) {
                        // 重新获取排序后的数据
                        var sortedAchievements = objectiveAchievements[i].sort(function(a, b) {
                            return a - b;
                        });
                        
                        // 重新生成标签
                        var labels = [];
                        for (var j = 1; j <= sortedAchievements.length; j++) {
                            labels.push(j.toString());
                        }
                        
                        // 获取canvas元素
                        var canvasId = 'objective-' + (i + 1) + '-chart';
                        var canvas = document.getElementById(canvasId);
                        
                        if (canvas) {
                            // 确保canvas上下文存在
                            var ctx = canvas.getContext('2d');
                            if (ctx) {
                                try {
                                    // 销毁现有图表（如果存在）
                                    if (window['objective' + (i + 1) + 'Chart']) {
                                        window['objective' + (i + 1) + 'Chart'].destroy();
                                    }
                                    
                                    // 生成期望值数据（0.7）
                                    var expectationValues = Array(sortedAchievements.length).fill(0.7);
                                    
                                    // 创建明确的折线图配置
                                    var chartConfig = {
                                        type: 'line', // 明确指定图表类型为折线图
                                        data: {
                                            labels: labels, // 确保标签是数组
                                            datasets: [{
                                                label: '达成度',
                                                data: sortedAchievements, // 确保数据是数组
                                                borderColor: 'rgba(59, 130, 246, 1)',
                                                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                                                borderWidth: 2,
                                                pointRadius: 3,
                                                pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                                                pointBorderColor: '#fff',
                                                pointHoverRadius: 5,
                                                fill: true,
                                                tension: 0.1,
                                                showLine: true // 明确显示线条
                                            }, {
                                                label: '期望值',
                                                data: expectationValues,
                                                borderColor: 'rgba(255, 99, 132, 1)',
                                                borderWidth: 2,
                                                borderDash: [5, 5],
                                                backgroundColor: 'transparent',
                                                pointRadius: 0,
                                                fill: false,
                                                tension: 0
                                            }]
                                        },
                                        options: {
                                            responsive: true,
                                            maintainAspectRatio: false,
                                            plugins: {
                                                legend: {
                                                    display: true,
                                                    position: 'top'
                                                }
                                            },
                                            scales: {
                                                x: {
                                                    type: 'category', // 明确指定x轴类型为分类
                                                    title: {
                                                        display: true,
                                                        text: '人数'
                                                    }
                                                },
                                                y: {
                                                    beginAtZero: true,
                                                    max: 1,
                                                    ticks: {
                                                        stepSize: 0.1
                                                    }
                                                }
                                            }
                                        }
                                    };
                                    
                                    console.log('创建折线图配置:', chartConfig);
                                    console.log('数据类型:', typeof sortedAchievements, '数据长度:', sortedAchievements.length);
                                    console.log('标签类型:', typeof labels, '标签长度:', labels.length);
                                    
                                    // 创建图表
                                    var chart = new Chart(ctx, chartConfig);
                                    
                                    // 存储图表实例
                                    window.individualCharts[i] = chart;
                                    window['objective' + (i + 1) + 'Chart'] = chart;
                                    
                                    console.log('成功创建课程目标' + (i + 1) + '的折线图，图表类型:', chart.config.type);
                                } catch (error) {
                                    console.error('创建课程目标' + (i + 1) + '图表时出错:', error);
                                }
                            } else {
                                console.error('无法获取canvas上下文:', canvasId);
                            }
                        } else {
                            console.error('未找到canvas元素:', canvasId);
                        }
                    }
                    
                    // 添加导出按钮事件监听器
                    setTimeout(function() {
                        var buttons = document.querySelectorAll('.export-individual-chart');
                        console.log('找到导出按钮数量:', buttons.length);
                        
                        buttons.forEach(function(button) {
                            button.addEventListener('click', function() {
                                var objective = parseInt(this.dataset.objective);
                                console.log('点击导出按钮，课程目标:', objective);
                                
                                if (window.individualCharts && window.individualCharts[objective - 1]) {
                                    console.log('导出图表，图表类型:', window.individualCharts[objective - 1].config.type);
                                    exportChart(window.individualCharts[objective - 1], '课程目标' + objective + '达成情况.png');
                                } else {
                                    console.error('未找到图表实例:', objective);
                                }
                            });
                        });
                    }, 100);
                }, 500); // 确保DOM元素完全创建
            }

            // 生成问卷调查表格
            function generateQuestionnaireTable() {
                console.log('generateQuestionnaireTable 函数被调用');
                var questionnaireTableBody = document.getElementById('questionnaire-table-body');
                if (!questionnaireTableBody) {
                    console.log('未找到 questionnaire-table-body 元素');
                    return;
                }
                
                // 保存用户之前填写的数据
                var savedData = [];
                var existingRows = questionnaireTableBody.querySelectorAll('tr');
                existingRows.forEach(function(row, index) {
                    var cells = row.querySelectorAll('td');
                    if (cells.length >= 9) {
                        // 保存问题内容
                        var questionInput = row.querySelector('td:nth-child(2) input');
                        var question = questionInput ? questionInput.value : '';
                        
                        // 保存各选项数量
                        var fullyAchievedInput = row.querySelector('td:nth-child(4) input');
                        var wellAchievedInput = row.querySelector('td:nth-child(5) input');
                        var basicallyAchievedInput = row.querySelector('td:nth-child(6) input');
                        var notAchievedInput = row.querySelector('td:nth-child(7) input');
                        
                        var fullyAchieved = parseFloat(fullyAchievedInput.value) || 0;
                        var wellAchieved = parseFloat(wellAchievedInput.value) || 0;
                        var basicallyAchieved = parseFloat(basicallyAchievedInput.value) || 0;
                        var notAchieved = parseFloat(notAchievedInput.value) || 0;
                        
                        savedData[index] = {
                            question: question,
                            fullyAchieved: fullyAchieved,
                            wellAchieved: wellAchieved,
                            basicallyAchieved: basicallyAchieved,
                            notAchieved: notAchieved
                        };
                    }
                });
                console.log('保存用户之前填写的数据:', savedData);
                
                // 清空表格
                questionnaireTableBody.innerHTML = '';
                
                // 获取课程目标数量
                var objectiveCount = document.querySelectorAll('.objective-item').length;
                console.log('课程目标数量:', objectiveCount);
                
                if (objectiveCount === 0) {
                    console.log('课程目标数量为0');
                    return;
                }
                
                // 获取第2步的权重计算结果
                var weights = [];
                if (window.calculatedObjectives) {
                    weights = window.calculatedObjectives;
                    console.log('从window.calculatedObjectives获取权重:', weights);
                } else {
                    // 如果window.calculatedObjectives不存在，从权重结果表格获取
                    var weightResultsBody = document.getElementById('weight-results');
                    if (weightResultsBody) {
                        var weightRows = weightResultsBody.querySelectorAll('tr');
                        weightRows.forEach(function(row, index) {
                            var weightCell = row.querySelector('td:last-child');
                            if (weightCell) {
                                var weight = parseFloat(weightCell.textContent) || 0;
                                weights[index] = { weight: weight };
                            }
                        });
                        console.log('从权重结果表格获取权重:', weights);
                    }
                }
                
                // 遍历每个课程目标
                for (var i = 1; i <= objectiveCount; i++) {
                    // 获取课程目标描述
                    var objectiveDescElement = document.getElementById('objective-' + i + '-desc');
                    var objectiveDesc = objectiveDescElement ? objectiveDescElement.value : '';
                    
                    // 获取对应毕业要求指标点
                    var objectiveRequirementElement = document.getElementById('objective-' + i + '-requirement');
                    var objectiveRequirement = objectiveRequirementElement ? objectiveRequirementElement.value : '';
                    
                    // 获取权重
                    var weight = weights[i - 1] ? weights[i - 1].weight : 0;
                    
                    // 创建问卷调查行
                    var newRow = document.createElement('tr');
                    newRow.innerHTML = '<td class="px-4 py-2">课程目标' + i + '</td>' +
                        '<td class="px-4 py-2"><input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="请输入课程目标达成情况相关问题"></td>' +
                        '<td class="px-4 py-2 font-medium text-primary">' + weight.toFixed(3) + '</td>' +
                        '<td class="px-4 py-2"><input type="number" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md" value="0" min="0" oninput="calculateQuestionnaire()"></td>' +
                        '<td class="px-4 py-2"><input type="number" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md" value="0" min="0" oninput="calculateQuestionnaire()"></td>' +
                        '<td class="px-4 py-2"><input type="number" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md" value="0" min="0" oninput="calculateQuestionnaire()"></td>' +
                        '<td class="px-4 py-2"><input type="number" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md" value="0" min="0" oninput="calculateQuestionnaire()"></td>' +
                        '<td class="px-4 py-2 font-medium text-primary objective-achievement">0.000</td>' +
                        '<td class="px-4 py-2 font-medium text-primary total-achievement">0.000</td>';
                    questionnaireTableBody.appendChild(newRow);
                }
                
                // 恢复用户之前填写的数据
                var newRows = questionnaireTableBody.querySelectorAll('tr');
                newRows.forEach(function(row, index) {
                    if (savedData[index]) {
                        // 恢复问题内容
                        var questionInput = row.querySelector('td:nth-child(2) input');
                        if (questionInput) {
                            questionInput.value = savedData[index].question;
                        }
                        
                        // 恢复各选项数量
                        var fullyAchievedInput = row.querySelector('td:nth-child(4) input');
                        var wellAchievedInput = row.querySelector('td:nth-child(5) input');
                        var basicallyAchievedInput = row.querySelector('td:nth-child(6) input');
                        var notAchievedInput = row.querySelector('td:nth-child(7) input');
                        
                        if (fullyAchievedInput) fullyAchievedInput.value = savedData[index].fullyAchieved;
                        if (wellAchievedInput) wellAchievedInput.value = savedData[index].wellAchieved;
                        if (basicallyAchievedInput) basicallyAchievedInput.value = savedData[index].basicallyAchieved;
                        if (notAchievedInput) notAchievedInput.value = savedData[index].notAchieved;
                    }
                });
                console.log('恢复用户之前填写的数据完成');
                
                // 添加计算按钮事件监听器
                var calculateQuestionnaireBtn = document.getElementById('calculate-questionnaire');
                if (calculateQuestionnaireBtn) {
                    calculateQuestionnaireBtn.addEventListener('click', function() {
                        calculateQuestionnaire();
                        alert('问卷调查数据计算完成！');
                    });
                }
                
                // 初始化计算
                calculateQuestionnaire();
            }
            
            // 计算问卷调查达成度
            function calculateQuestionnaire() {
                console.log('calculateQuestionnaire 函数被调用');
                var questionnaireTableBody = document.getElementById('questionnaire-table-body');
                if (!questionnaireTableBody) {
                    console.log('未找到 questionnaire-table-body 元素');
                    return;
                }
                
                // 获取所有问卷调查行
                var questionnaireRows = questionnaireTableBody.querySelectorAll('tr');
                var totalWeight = 0;
                var weightedAchievements = 0;
                
                // 遍历每个课程目标行
                questionnaireRows.forEach(function(row, index) {
                    // 获取权重
                    var weightCell = row.querySelector('td:nth-child(3)');
                    var weight = parseFloat(weightCell.textContent) || 0;
                    totalWeight += weight;
                    
                    // 获取用户填写的数量
                    var fullyAchievedInput = row.querySelector('td:nth-child(4) input');
                    var wellAchievedInput = row.querySelector('td:nth-child(5) input');
                    var basicallyAchievedInput = row.querySelector('td:nth-child(6) input');
                    var notAchievedInput = row.querySelector('td:nth-child(7) input');
                    
                    var fullyAchieved = parseInt(fullyAchievedInput.value) || 0;
                    var wellAchieved = parseInt(wellAchievedInput.value) || 0;
                    var basicallyAchieved = parseInt(basicallyAchievedInput.value) || 0;
                    var notAchieved = parseInt(notAchievedInput.value) || 0;
                    
                    // 计算总人数
                    var totalResponses = fullyAchieved + wellAchieved + basicallyAchieved + notAchieved;
                    
                    // 计算各选项的比例
                    var fullyAchievedRatio = totalResponses > 0 ? fullyAchieved / totalResponses : 0;
                    var wellAchievedRatio = totalResponses > 0 ? wellAchieved / totalResponses : 0;
                    var basicallyAchievedRatio = totalResponses > 0 ? basicallyAchieved / totalResponses : 0;
                    var notAchievedRatio = totalResponses > 0 ? notAchieved / totalResponses : 0;
                    
                    // 计算加权平均分（完全达成95分、较好达成85分、基本达成70分、未达成60分）
                    var weightedScore = (fullyAchievedRatio * 95) + (wellAchievedRatio * 85) + (basicallyAchievedRatio * 70) + (notAchievedRatio * 60);
                    
                    // 计算达成度（转换为0-1范围）
                    var achievement = weightedScore / 100;
                    
                    // 更新各课程目标达成度
                    var objectiveAchievementCell = row.querySelector('.objective-achievement');
                    objectiveAchievementCell.textContent = achievement.toFixed(3);
                    
                    // 累加加权达成度
                    weightedAchievements += achievement * weight;
                });
                
                // 计算课程目标总的达成度
                var totalAchievement = totalWeight > 0 ? weightedAchievements / totalWeight : 0;
                
                // 更新所有行的课程目标达成度
                questionnaireRows.forEach(function(row) {
                    var totalAchievementCell = row.querySelector('.total-achievement');
                    totalAchievementCell.textContent = totalAchievement.toFixed(3);
                });
            }
            
            // 导出问卷调查
            function exportQuestionnaire() {
                console.log('导出问卷调查');
                // 这里可以添加导出问卷调查的逻辑
                alert('问卷调查导出功能已触发');
            }
            
            // 计算平均分
            function calculateAverages() {
                console.log('calculateAverages 函数被调用');
                var tableBody = document.getElementById('students-table-body');
                var studentRows = tableBody.querySelectorAll('tr');
                var studentCount = studentRows.length;
                console.log('学生数量:', studentCount);
                
                if (studentCount === 0) {
                    // 如果没有学生，重置所有平均分
                    var dailyAverage = document.querySelector('#students-table-footer .daily-average');
                    var examAverage = document.querySelector('#students-table-footer .exam-average');
                    var questionAverages = document.querySelectorAll('#students-table-footer .question-average');
                    
                    if (dailyAverage) dailyAverage.textContent = '0.0';
                    if (examAverage) examAverage.textContent = '0.0';
                    questionAverages.forEach(function(span) {
                        span.textContent = '0.0';
                    });
                    return;
                }
                
                // 初始化总分
                var totalDaily = 0;
                var totalExam = 0;
                var totalQuestions = {};
                
                // 遍历所有学生
                studentRows.forEach(function(row, index) {
                    var inputs = row.querySelectorAll('input');
                    console.log('学生行', index + 1, '输入框数量:', inputs.length);
                    if (inputs.length < 3) return;
                    
                    // 计算平时成绩总分
                    var dailyScore = parseFloat(inputs[1].value) || 0;
                    totalDaily += dailyScore;
                    console.log('学生行', index + 1, '平时成绩:', dailyScore);
                    
                    // 计算期末成绩总分
                    var examScore = parseFloat(inputs[2].value) || 0;
                    totalExam += examScore;
                    console.log('学生行', index + 1, '期末成绩:', examScore);
                    
                    // 计算每个题目的总分
                    var questionInputs = Array.from(inputs).slice(3);
                    var globalExamItems = document.getElementById('global-exam-items');
                    if (globalExamItems) {
                        var globalRows = globalExamItems.querySelectorAll('tr');
                        globalRows.forEach(function(globalRow, qIndex) {
                            var nameSpan = globalRow.querySelector('.global-question-name');
                            if (nameSpan && questionInputs[qIndex]) {
                                var questionName = nameSpan.textContent;
                                var score = parseFloat(questionInputs[qIndex].value) || 0;
                                if (!totalQuestions[questionName]) {
                                    totalQuestions[questionName] = 0;
                                }
                                totalQuestions[questionName] += score;
                                console.log('学生行', index + 1, '题目', questionName, '得分:', score);
                            }
                        });
                    }
                });
                
                // 计算平均分
                var avgDaily = totalDaily / studentCount;
                var avgExam = totalExam / studentCount;
                console.log('平时成绩总分:', totalDaily, '平均分:', avgDaily);
                console.log('期末成绩总分:', totalExam, '平均分:', avgExam);
                console.log('题目得分:', totalQuestions);
                
                // 更新平均分显示
                var dailyAverage = document.querySelector('#students-table-footer .daily-average');
                var examAverage = document.querySelector('#students-table-footer .exam-average');
                var questionAverages = document.querySelectorAll('#students-table-footer .question-average');
                
                if (dailyAverage) dailyAverage.textContent = avgDaily.toFixed(1);
                if (examAverage) examAverage.textContent = avgExam.toFixed(1);
                
                // 更新每个题目的平均分
                questionAverages.forEach(function(span) {
                    var questionName = span.dataset.question;
                    console.log('更新题目平均分:', questionName);
                    if (totalQuestions[questionName]) {
                        var avgQuestion = totalQuestions[questionName] / studentCount;
                        span.textContent = avgQuestion.toFixed(1);
                        console.log('题目', questionName, '总分:', totalQuestions[questionName], '平均分:', avgQuestion);
                    } else {
                        span.textContent = '0.0';
                        console.log('题目', questionName, '无得分，显示0.0');
                    }
                });
            }

            // 为学生成绩输入框添加事件监听器
            function addStudentScoreListeners() {
                var tableBody = document.getElementById('students-table-body');
                var studentRows = tableBody.querySelectorAll('tr');
                
                studentRows.forEach(function(row) {
                    var inputs = row.querySelectorAll('input');
                    inputs.forEach(function(input, index) {
                        // 跳过学生姓名输入框（索引0）
                        if (index === 0) return;
                        
                        // 添加输入事件监听器
                        input.addEventListener('input', function() {
                            calculateAverages();
                        });
                    });
                });
            }

            // 为添加学生按钮添加事件监听器
            var addStudentBtn = document.getElementById('add-student');
            if (addStudentBtn) {
                // 移除现有的事件监听器（如果有）
                var newAddStudentBtn = addStudentBtn.cloneNode(true);
                addStudentBtn.parentNode.replaceChild(newAddStudentBtn, addStudentBtn);
                
                // 添加新的事件监听器
                newAddStudentBtn.addEventListener('click', function() {
                    var tableBody = document.getElementById('students-table-body');
                    var globalExamItems = document.getElementById('global-exam-items');
                    if (!tableBody || !globalExamItems) return;
                    
                    var globalRows = globalExamItems.querySelectorAll('tr');
                    addStudentRow(tableBody, globalRows);
                    
                    // 计算平均分
                    calculateAverages();
                    
                    // 为新添加的学生行添加事件监听器
                    addStudentScoreListeners();
                });
            }

            // 为计算平均分按钮添加点击事件监听器
            var calculateAveragesBtn = document.getElementById('calculate-averages');
            if (calculateAveragesBtn) {
                calculateAveragesBtn.addEventListener('click', function() {
                    calculateAverages();
                });
            }


            document.getElementById('back-to-step-1').addEventListener('click', function() {
                showStep(1);
            });



            // 添加课程目标
            document.getElementById('add-objective').addEventListener('click', function() {
                var courseObjectives = document.getElementById('course-objectives');
                var objectiveCount = courseObjectives.children.length + 1;

                var newObjective = document.createElement('div');
                newObjective.className = 'objective-item border border-gray-200 rounded-md p-4 mb-4';
                newObjective.innerHTML = '<div class="flex justify-between items-center mb-2">' +
                    '<h4 class="font-medium">课程目标' + objectiveCount + '</h4>' +
                    '<button class="text-red-500 hover:text-red-700 delete-objective">删除</button>' +
                '</div>' +
                '<div class="grid grid-cols-1 md:grid-cols-4 gap-4">' +
                    '<div>' +
                        '<label class="block text-gray-700 mb-2">目标描述</label>' +
                        '<textarea id="objective-' + objectiveCount + '-desc" rows="3" ' +
                                  'class="w-full px-4 py-2 border border-gray-300 rounded-md form-input-focus"></textarea>' +
                    '</div>' +
                    '<div>' +
                        '<label class="block text-gray-700 mb-2">对应毕业要求指标点</label>' +
                        '<input type="text" id="objective-' + objectiveCount + '-requirement" ' +
                               'class="w-full px-4 py-2 border border-gray-300 rounded-md form-input-focus">' +
                    '</div>' +
                    '<div>' +
                        '<label class="block text-gray-700 mb-2">支撑程度</label>' +
                        '<select id="objective-' + objectiveCount + '-support-level" ' +
                                'class="w-full px-4 py-2 border border-gray-300 rounded-md form-input-focus">' +
                            '<option value="H">H（高）</option>' +
                            '<option value="M" selected>M（中）</option>' +
                            '<option value="L">L（低）</option>' +
                        '</select>' +
                    '</div>' +
                    '<div>' +
                        '<label class="block text-gray-700 mb-2">对应毕业要求具体指标点</label>' +
                        '<textarea id="objective-' + objectiveCount + '-specific-requirement" rows="3" ' +
                                  'class="w-full px-4 py-2 border border-gray-300 rounded-md form-input-focus"></textarea>' +
                    '</div>' +
                '</div>';

                courseObjectives.appendChild(newObjective);

                // 在权重设置部分添加对应的课程目标行
                var weightResultsBody = document.getElementById('weight-results');
                if (weightResultsBody) {
                    var newWeightRow = document.createElement('tr');
                    newWeightRow.innerHTML = '<td class="px-6 py-4 whitespace-nowrap">课程目标' + objectiveCount + '</td>' +
                        '<td class="px-6 py-4 whitespace-nowrap"></td>' +
                        '<td class="px-6 py-4 whitespace-nowrap font-medium text-primary">0.000</td>';
                    weightResultsBody.appendChild(newWeightRow);
                }

                // 在权重设置部分添加对应的平时成绩占比和期末成绩题目设置
                var step2Content = document.getElementById('step-2');
                if (step2Content) {
                    // 创建新的课程目标权重设置部分
                    var newObjectiveWeightSection = document.createElement('div');
                    newObjectiveWeightSection.className = 'mb-8 border border-gray-200 rounded-md p-6';
                    newObjectiveWeightSection.innerHTML = '<h3 class="text-lg font-semibold mb-4">课程目标' + objectiveCount + '</h3>' +
                        '<div class="mb-4">' +
                            '<label class="block text-gray-700 mb-2">平时成绩占比（%）</label>' +
                            '<input type="number" id="objective-' + objectiveCount + '-daily-percentage" class="w-full px-4 py-2 border border-gray-300 rounded-md form-input-focus" value="33" min="0" max="100">' +
                        '</div>' +
                        '<div>' +
                                '<h4 class="font-medium mb-2">期末成绩题目设置</h4>' +
                                '<div class="flex justify-between items-center mb-2">' +
                                    '<p class="text-gray-600">请输入期末每一个小题的占比（总分已从期末考试设置中同步）</p>' +
                                '</div>' +
                                '<div class="overflow-x-auto">' +
                                '<table class="min-w-full divide-y divide-gray-200">' +
                                    '<thead class="bg-gray-50">' +
                                        '<tr>' +
                                            '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">题目</th>' +
                                            '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">总分</th>' +
                                            '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">占比（%）</th>' +
                                        '</tr>' +
                                    '</thead>' +
                                    '<tbody class="bg-white divide-y divide-gray-200" id="objective-' + objectiveCount + '-exam-items">' +
                                    '</tbody>' +
                                '</table>' +
                            '</div>' +
                        '</div>';
                    
                    // 将新的课程目标权重设置部分添加到步骤2的合适位置（在权重结果表格之前）
                    var weightResultsTable = document.getElementById('weight-results');
                    if (weightResultsTable) {
                        var parentElement = weightResultsTable.closest('div');
                        if (parentElement) {
                            parentElement.parentNode.insertBefore(newObjectiveWeightSection, parentElement);
                        }
                    }
                }
                
                // 同步所有课程目标的期末成绩题目设置
                syncAllObjectivesExamItems();

                // 添加删除事件
                var deleteButton = newObjective.querySelector('.delete-objective');
                deleteButton.addEventListener('click', function() {
                    newObjective.parentNode.removeChild(newObjective);
                    // 更新目标编号
                    updateObjectiveNumbers();
                    // 删除对应权重行
                    var weightResultsBody = document.getElementById('weight-results');
                    if (weightResultsBody && weightResultsBody.children.length > 0) {
                        weightResultsBody.removeChild(weightResultsBody.lastChild);
                    }

                    // 删除对应权重设置部分
                    var step2Content = document.getElementById('step-2');
                    if (step2Content) {
                        // 找到所有课程目标权重设置部分
                        var objectiveWeightSections = step2Content.querySelectorAll('.mb-8.border.border-gray-200.rounded-md.p-6');
                        // 删除最后一个权重设置部分
                        if (objectiveWeightSections.length > 0) {
                            objectiveWeightSections[objectiveWeightSections.length - 1].remove();
                        }
                    }
                });
            });

            // 删除课程目标
            function addDeleteObjectiveListeners() {
                var deleteButtons = document.querySelectorAll('.delete-objective-btn');
                deleteButtons.forEach(function(button) {
                    button.addEventListener('click', function() {
                        var objectiveItem = this.closest('.objective-item');
                        var objectiveCount = document.querySelectorAll('.objective-item').length;
                        
                        // 确保至少保留2个课程目标
                        if (objectiveCount <= 2) {
                            alert('至少需要保留2个课程目标');
                            return;
                        }
                        
                        objectiveItem.remove();
                        // 更新目标编号
                        updateObjectiveNumbers();
                        // 删除对应权重行
                        var weightResultsBody = document.getElementById('weight-results');
                        if (weightResultsBody && weightResultsBody.children.length > 0) {
                            // 重新计算目标数量，删除多余的权重行
                            var newObjectiveCount = document.querySelectorAll('.objective-item').length;
                            while (weightResultsBody.children.length > newObjectiveCount) {
                                weightResultsBody.removeChild(weightResultsBody.lastChild);
                            }
                        }

                        // 删除对应权重设置部分
                        var step2Content = document.getElementById('step-2');
                        if (step2Content) {
                            // 找到所有课程目标权重设置部分
                            var objectiveWeightSections = step2Content.querySelectorAll('.mb-8.border.border-gray-200.rounded-md.p-6');
                            // 重新计算目标数量，删除多余的权重设置部分
                            var newObjectiveCount = document.querySelectorAll('.objective-item').length;
                            while (objectiveWeightSections.length > newObjectiveCount) {
                                objectiveWeightSections[objectiveWeightSections.length - 1].remove();
                                // 重新获取列表，因为DOM已经改变
                                objectiveWeightSections = step2Content.querySelectorAll('.mb-8.border.border-gray-200.rounded-md.p-6');
                            }
                        }
                    });
                });
            }
            
            // 初始添加删除按钮监听器
            addDeleteObjectiveListeners();
            
            // 为添加课程目标按钮添加事件监听器
            document.getElementById('add-objective').addEventListener('click', function() {
                var courseObjectives = document.getElementById('course-objectives');
                var objectiveCount = courseObjectives.children.length + 1;

                var newObjective = document.createElement('div');
                newObjective.className = 'objective-item border border-gray-200 rounded-md p-4 mb-4';
                newObjective.innerHTML = '<div class="flex justify-between items-center mb-4">' +
                    '<h4 class="font-medium">课程目标' + objectiveCount + '</h4>' +
                    '<button class="delete-objective-btn text-red-500 hover:text-red-700 text-sm">删除</button>' +
                '</div>' +
                '<div class="grid grid-cols-1 md:grid-cols-4 gap-4">' +
                    '<div>' +
                        '<label class="block text-gray-700 mb-2">目标描述</label>' +
                        '<textarea id="objective-' + objectiveCount + '-desc" rows="3" ' +
                                  'class="w-full px-4 py-2 border border-gray-300 rounded-md form-input-focus"></textarea>' +
                    '</div>' +
                    '<div>' +
                        '<label class="block text-gray-700 mb-2">对应毕业要求指标点</label>' +
                        '<input type="text" id="objective-' + objectiveCount + '-requirement" ' +
                               'class="w-full px-4 py-2 border border-gray-300 rounded-md form-input-focus">' +
                    '</div>' +
                    '<div>' +
                        '<label class="block text-gray-700 mb-2">支撑程度</label>' +
                        '<select id="objective-' + objectiveCount + '-support-level" ' +
                                'class="w-full px-4 py-2 border border-gray-300 rounded-md form-input-focus">' +
                            '<option value="H">H（高）</option>' +
                            '<option value="M" selected>M（中）</option>' +
                            '<option value="L">L（低）</option>' +
                        '</select>' +
                    '</div>' +
                    '<div>' +
                        '<label class="block text-gray-700 mb-2">对应毕业要求具体指标点</label>' +
                        '<textarea id="objective-' + objectiveCount + '-specific-requirement" rows="3" ' +
                                  'class="w-full px-4 py-2 border border-gray-300 rounded-md form-input-focus"></textarea>' +
                    '</div>' +
                '</div>';

                courseObjectives.appendChild(newObjective);

                // 在权重设置部分添加对应的课程目标行
                var weightResultsBody = document.getElementById('weight-results');
                if (weightResultsBody) {
                    var newWeightRow = document.createElement('tr');
                    newWeightRow.innerHTML = '<td class="px-6 py-4 whitespace-nowrap">课程目标' + objectiveCount + '</td>' +
                        '<td class="px-6 py-4 whitespace-nowrap"></td>' +
                        '<td class="px-6 py-4 whitespace-nowrap font-medium text-primary">0.000</td>';
                    weightResultsBody.appendChild(newWeightRow);
                }

                // 在权重设置部分添加对应的平时成绩占比和期末成绩题目设置
                var step2Content = document.getElementById('step-2');
                if (step2Content) {
                    // 创建新的课程目标权重设置部分
                    var newObjectiveWeightSection = document.createElement('div');
                    newObjectiveWeightSection.className = 'mb-8 border border-gray-200 rounded-md p-6';
                    newObjectiveWeightSection.innerHTML = '<h3 class="text-lg font-semibold mb-4">课程目标' + objectiveCount + '</h3>' +
                        '<div class="mb-4">' +
                            '<label class="block text-gray-700 mb-2">平时成绩占比（%）</label>' +
                            '<input type="number" id="objective-' + objectiveCount + '-daily-percentage" class="w-full px-4 py-2 border border-gray-300 rounded-md form-input-focus" value="33" min="0" max="100">' +
                        '</div>' +
                        '<div>' +
                                '<h4 class="font-medium mb-2">期末成绩题目设置</h4>' +
                                '<div class="flex justify-between items-center mb-2">' +
                                    '<p class="text-gray-600">请输入期末每一个小题的占比（总分已从期末考试设置中同步）</p>' +
                                '</div>' +
                                '<div class="overflow-x-auto">' +
                                '<table class="min-w-full divide-y divide-gray-200">' +
                                    '<thead class="bg-gray-50">' +
                                        '<tr>' +
                                            '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">题目</th>' +
                                            '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">总分</th>' +
                                            '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">占比（%）</th>' +
                                        '</tr>' +
                                    '</thead>' +
                                    '<tbody class="bg-white divide-y divide-gray-200" id="objective-' + objectiveCount + '-exam-items">' +
                                    '</tbody>' +
                                '</table>' +
                            '</div>' +
                        '</div>';
                    
                    // 将新的课程目标权重设置部分添加到步骤2的合适位置（在权重结果表格之前）
                    var weightResultsTable = document.getElementById('weight-results');
                    if (weightResultsTable) {
                        var parentElement = weightResultsTable.closest('div');
                        if (parentElement) {
                            parentElement.parentNode.insertBefore(newObjectiveWeightSection, parentElement);
                        }
                    }
                }
                
                // 同步所有课程目标的期末成绩题目设置
                syncAllObjectivesExamItems();

                // 添加删除事件
                addDeleteObjectiveListeners();
            });

            // 更新目标编号
            function updateObjectiveNumbers() {
                var objectiveItems = document.querySelectorAll('.objective-item');
                for (var index = 0; index < objectiveItems.length; index++) {
                    var item = objectiveItems[index];
                    var objectiveNumber = index + 1;
                    
                    // 更新标题
                    var h4 = item.querySelector('h4');
                    if (h4) {
                        h4.textContent = '课程目标' + objectiveNumber;
                    }
                    
                    // 更新表单元素的ID
                    var textareas = item.querySelectorAll('textarea');
                    if (textareas.length > 0) {
                        textareas[0].id = 'objective-' + objectiveNumber + '-desc';
                    }
                    
                    var inputs = item.querySelectorAll('input');
                    if (inputs.length > 0) {
                        inputs[0].id = 'objective-' + objectiveNumber + '-requirement';
                    }
                    
                    if (inputs.length > 1) {
                        inputs[1].id = 'objective-' + objectiveNumber + '-specific-requirement';
                    }
                }
                
                // 更新权重结果表格中的编号
                var weightResultsBody = document.getElementById('weight-results');
                if (weightResultsBody) {
                    var weightRows = weightResultsBody.querySelectorAll('tr');
                    weightRows.forEach(function(row, index) {
                        var objectiveNumber = index + 1;
                        var firstCell = row.querySelector('td:first-child');
                        if (firstCell) {
                            firstCell.textContent = '课程目标' + objectiveNumber;
                        }
                    });
                }
                
                // 更新步骤2中的课程目标编号
                var step2Content = document.getElementById('step-2');
                if (step2Content) {
                    var objectiveWeightSections = step2Content.querySelectorAll('.mb-8.border.border-gray-200.rounded-md.p-6');
                    objectiveWeightSections.forEach(function(section, index) {
                        var objectiveNumber = index + 1;
                        
                        // 更新标题
                        var h3 = section.querySelector('h3');
                        if (h3) {
                            h3.textContent = '课程目标' + objectiveNumber;
                        }
                        
                        // 更新输入框ID
                        var dailyPercentageInput = section.querySelector('input[id^="objective-"]');
                        if (dailyPercentageInput) {
                            dailyPercentageInput.id = 'objective-' + objectiveNumber + '-daily-percentage';
                        }
                        
                        // 更新表格ID
                        var examItemsTable = section.querySelector('tbody[id^="objective-"]');
                        if (examItemsTable) {
                            examItemsTable.id = 'objective-' + objectiveNumber + '-exam-items';
                        }
                    });
                }
            }


            // 为现有全局期末考试设置中的分数输入框添加事件监听器
            document.querySelectorAll('.global-question-score').forEach(function(input) {
                input.addEventListener('change', function() {
                    // 直接调用同步函数，确保所有课程目标都与全局期末考试设置保持一致
                    syncAllObjectivesExamItems();
                });
            });

            // 为生成报告按钮添加事件监听器
            document.getElementById('generate-report').addEventListener('click', function() {
                console.log('生成报告按钮被点击');
                
                var usageCount = getUsageCount();
                console.log('当前使用次数:', usageCount);
                
                // 生成报告
                generateReport();
                
                // 增加使用次数
                incrementUsageCount();
                console.log('使用次数已增加');
                
                // 更新支付提示信息
                updatePaymentPrompt();
                console.log('支付提示信息已更新');
            });
            
            // 页面加载时初始化
            window.addEventListener('load', function() {
                // 初始化使用次数
                initUsageCount();
                
                // 更新支付提示信息
                updatePaymentPrompt();
                
                // 为导出达成度按钮添加事件监听器
                var exportAchievementsBtn = document.getElementById('export-achievements');
                if (exportAchievementsBtn) {
                    exportAchievementsBtn.addEventListener('click', exportAchievements);
                }
            });
            
            // 初始化使用次数
            function initUsageCount() {
                // 检查本地存储中是否有使用次数
                if (!localStorage.getItem('reportUsageCount')) {
                    // 首次使用，设置使用次数为0
                    localStorage.setItem('reportUsageCount', '0');
                }
            }
            
            // 获取使用次数
            function getUsageCount() {
                return parseInt(localStorage.getItem('reportUsageCount')) || 0;
            }
            
            // 增加使用次数
            function incrementUsageCount() {
                var count = getUsageCount();
                localStorage.setItem('reportUsageCount', (count + 1).toString());
            }
            
            // 更新支付提示信息
            function updatePaymentPrompt() {
                var usageCount = getUsageCount();
                var paymentMessage = document.getElementById('payment-message');
                var qrCodeText = document.getElementById('qr-code-text');
                
                if (usageCount === 0) {
                    // 首次使用，免费
                    paymentMessage.textContent = '🎉 首次使用免费！感谢您选择我们的系统，您可以免费导出第一份分析报告。点击下方按钮开始生成报告。';
                    qrCodeText.textContent = '首次使用，无需支付';
                } else {
                    // 第二次及以上使用，提示免费次数已使用完毕
                    paymentMessage.textContent = '免费次数已使用完毕。每次导出分析报告需要支付8.88元。请扫描下方二维码完成支付，支付完成后点击"生成分析报告"按钮。';
                    qrCodeText.textContent = '请扫描二维码支付8.88元';
                }
            }
            
            // 导出达成度数据
            function exportAchievements() {
                var achievementsTableBody = document.getElementById('achievements-table-body');
                var achievementsTableHeader = document.getElementById('achievements-table-header');
                
                if (!achievementsTableBody || !achievementsTableHeader) {
                    alert('请先计算达成度');
                    return;
                }
                
                var headerRow = achievementsTableHeader.querySelector('tr');
                var headerCells = headerRow.querySelectorAll('th');
                
                var rows = achievementsTableBody.querySelectorAll('tr');
                if (rows.length === 0) {
                    alert('没有达成度数据可导出');
                    return;
                }
                
                // 生成CSV内容
                var csvContent = '';
                
                // 添加表头
                headerCells.forEach(function(cell, index) {
                    var text = cell.textContent;
                    // 如果文本包含逗号或引号，用引号包围并转义内部引号
                    if (text.includes(',') || text.includes('"')) {
                        text = '"' + text.replace(/"/g, '""') + '"';
                    }
                    csvContent += text;
                    if (index < headerCells.length - 1) {
                        csvContent += ',';
                    }
                });
                csvContent += '\n';
                
                // 添加数据行
                rows.forEach(function(row) {
                    var cells = row.querySelectorAll('td');
                    cells.forEach(function(cell, index) {
                        var text = cell.textContent;
                        // 如果文本包含逗号或引号，用引号包围并转义内部引号
                        if (text.includes(',') || text.includes('"')) {
                            text = '"' + text.replace(/"/g, '""') + '"';
                        }
                        csvContent += text;
                        if (index < cells.length - 1) {
                            csvContent += ',';
                        }
                    });
                    csvContent += '\n';
                });
                
                // 创建Blob对象，添加UTF-8 BOM以确保Windows系统正确识别中文编码
                var bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
                var blob = new Blob([bom, csvContent], { type: 'text/csv;charset=utf-8;' });
                var url = URL.createObjectURL(blob);
                var link = document.createElement('a');
                link.setAttribute('href', url);
                // 使用更通用的文件名，确保在所有操作系统上都能正常显示
                link.setAttribute('download', 'course-achievements.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // 提示用户导出成功
                setTimeout(function() {
                    alert('达成度数据导出成功！\n\n非苹果电脑用户请使用Excel或WPS表格打开文件，系统会自动识别编码。');
                }, 500);
            }

            // 计算达成度统计数据
            function calculateAchievementStats(overallAchievements, objectiveAchievements) {
                console.log('calculateAchievementStats 函数被调用');
                // 计算总达成度统计
                var totalSum = overallAchievements.reduce(function(sum, val) { return sum + val; }, 0);
                var totalAverage = overallAchievements.length > 0 ? totalSum / overallAchievements.length : 0;
                var passCount = overallAchievements.filter(function(val) { return val >= 0.6; }).length;
                var excellentCount = overallAchievements.filter(function(val) { return val >= 0.8; }).length;
                var passRate = overallAchievements.length > 0 ? (passCount / overallAchievements.length) * 100 : 0;
                var excellentRate = overallAchievements.length > 0 ? (excellentCount / overallAchievements.length) * 100 : 0;
                
                // 计算各课程目标统计
                var objectiveStats = [];
                objectiveAchievements.forEach(function(achievements, index) {
                    var sum = achievements.reduce(function(s, val) { return s + val; }, 0);
                    var average = achievements.length > 0 ? sum / achievements.length : 0;
                    var objPassCount = achievements.filter(function(val) { return val >= 0.6; }).length;
                    var objExcellentCount = achievements.filter(function(val) { return val >= 0.8; }).length;
                    var objPassRate = achievements.length > 0 ? (objPassCount / achievements.length) * 100 : 0;
                    var objExcellentRate = achievements.length > 0 ? (objExcellentCount / achievements.length) * 100 : 0;
                    
                    objectiveStats.push({
                        index: index,
                        average: average,
                        passRate: objPassRate,
                        excellentRate: objExcellentRate,
                        achievements: achievements
                    });
                });
                
                return {
                    totalAverage: totalAverage,
                    passRate: passRate,
                    excellentRate: excellentRate,
                    objectiveStats: objectiveStats,
                    overallAchievements: overallAchievements
                };
            }

            // 生成课程目标达成评价报告
            function generateReport() {
                console.log('generateReport 函数被调用');
                
                // 临时显示步骤2和步骤3的内容，确保可以获取到所有必要的信息
                var step2Content = document.getElementById('step-2');
                var step3Content = document.getElementById('step-3');
                var wasStep2Hidden = step2Content.classList.contains('hidden');
                var wasStep3Hidden = step3Content.classList.contains('hidden');
                
                if (wasStep2Hidden) {
                    step2Content.classList.remove('hidden');
                }
                if (wasStep3Hidden) {
                    step3Content.classList.remove('hidden');
                }
                
                // 强制重新渲染图表，确保图表实例存在
                setTimeout(function() {
                    console.log('重新渲染图表');
                    // 重新计算达成度，这会重新生成所有图表
                    calculateAchievements();
                    // 重新计算问卷调查数据
                    calculateQuestionnaire();
                    
                    // 等待更长时间，确保DOM完全更新
                    setTimeout(function() {
                        console.log('DOM更新完成，开始生成报告内容');
                        // 获取课程信息
                        var courseName = document.getElementById('course-name').value || '课程名称';
                        var className = document.getElementById('class-name').value || '班级';
                        var studentCount = document.getElementById('student-count').value || '0';
                        var evaluator = document.getElementById('evaluator').value || '评价人';
                        var major = '专业';
                        
                        // 获取达成度数据
                        var achievementsTableBody = document.getElementById('achievements-table-body');
                        if (!achievementsTableBody) {
                            alert('请先在第三步计算达成度');
                            // 恢复隐藏状态
                            if (wasStep3Hidden) {
                                step3Content.classList.add('hidden');
                            }
                            if (wasStep2Hidden) {
                                step2Content.classList.add('hidden');
                            }
                            return;
                        }
                        
                        var studentRows = achievementsTableBody.querySelectorAll('tr:not(.bg-gray-50)');
                        if (studentRows.length === 0) {
                            alert('请先在第三步输入学生成绩并计算达成度');
                            // 恢复隐藏状态
                            if (wasStep3Hidden) {
                                step3Content.classList.add('hidden');
                            }
                            if (wasStep2Hidden) {
                                step2Content.classList.add('hidden');
                            }
                            return;
                        }
                        
                        // 获取课程目标数量
                        var objectiveCount = document.querySelectorAll('.objective-item').length;
                        if (objectiveCount === 0) {
                            alert('请先在第一步设置课程目标');
                            // 恢复隐藏状态
                            if (wasStep3Hidden) {
                                step3Content.classList.add('hidden');
                            }
                            if (wasStep2Hidden) {
                                step2Content.classList.add('hidden');
                            }
                            return;
                        }
                        
                        // 收集数据
                        var overallAchievements = [];
                        var objectiveAchievements = [];
                        for (var i = 0; i < objectiveCount; i++) {
                            objectiveAchievements.push([]);
                        }
                        
                        // 遍历每个学生行
                        studentRows.forEach(function(row) {
                            var cells = row.querySelectorAll('td');
                            if (cells.length < 3 + objectiveCount + 1) return;
                            
                            // 提取总达成度
                            var overallAchievement = parseFloat(cells[3 + objectiveCount].textContent) || 0;
                            overallAchievements.push(overallAchievement);
                            
                            // 提取每个课程目标的达成度
                            for (var i = 0; i < objectiveCount; i++) {
                                var achievement = parseFloat(cells[i + 3].textContent) || 0;
                                objectiveAchievements[i].push(achievement);
                            }
                        });
                        
                        // 计算统计数据
                        var stats = calculateAchievementStats(overallAchievements, objectiveAchievements);
                        console.log('统计数据计算完成:', stats);
                        
                        // 获取用户选择的报告格式
                        var reportFormat = document.getElementById('report-format').value || 'word';
                        
                        // 生成报告内容
                        var actualStudentCount = studentRows.length;
                        var reportContent = generateReportContent(courseName, className, studentCount, evaluator, major, stats, objectiveCount, actualStudentCount);
                        console.log('报告内容生成完成');
                        
                        // 创建并下载报告文件
                        var filename = courseName + '课程目标达成评价报告.' + (reportFormat === 'word' ? 'docx' : 'html');
                        downloadReport(reportContent, filename, reportFormat);
                        console.log('报告下载完成');
                        
                        // 恢复隐藏状态
                        if (wasStep2Hidden) {
                            step2Content.classList.add('hidden');
                        }
                        if (wasStep3Hidden) {
                            step3Content.classList.add('hidden');
                        }
                    }, 2000); // 增加到2000ms延迟，确保DOM完全更新
                }, 100); // 先等待100ms让DOM更新
            }

            // 生成报告内容
            function generateReportContent(courseName, className, studentCount, evaluator, major, stats, objectiveCount, actualStudentCount) {
                // 如果没有提供实际学生人数，使用学生行数量
                if (!actualStudentCount) {
                    actualStudentCount = stats.overallAchievements.length;
                }
                
                // 获取课程目标描述和毕业要求
                var objective1Desc = document.getElementById('objective-1-desc') ? document.getElementById('objective-1-desc').value : '';
                var objective2Desc = document.getElementById('objective-2-desc') ? document.getElementById('objective-2-desc').value : '';
                var objective3Desc = document.getElementById('objective-3-desc') ? document.getElementById('objective-3-desc').value : '';
                
                var objective1Req = document.getElementById('objective-1-requirement') ? document.getElementById('objective-1-requirement').value : '';
                var objective2Req = document.getElementById('objective-2-requirement') ? document.getElementById('objective-2-requirement').value : '';
                var objective3Req = document.getElementById('objective-3-requirement') ? document.getElementById('objective-3-requirement').value : '';
                
                // 获取支撑程度
                var objective1Support = document.getElementById('objective-1-support-level') ? document.getElementById('objective-1-support-level').value : 'H';
                var objective2Support = document.getElementById('objective-2-support-level') ? document.getElementById('objective-2-support-level').value : 'L';
                var objective3Support = document.getElementById('objective-3-support-level') ? document.getElementById('objective-3-support-level').value : 'M';
                
                // 获取具体指标点描述
                var objective1SpecificReq = document.getElementById('objective-1-specific-requirement') ? document.getElementById('objective-1-specific-requirement').value : '';
                var objective2SpecificReq = document.getElementById('objective-2-specific-requirement') ? document.getElementById('objective-2-specific-requirement').value : '';
                var objective3SpecificReq = document.getElementById('objective-3-specific-requirement') ? document.getElementById('objective-3-specific-requirement').value : '';
                
                // 获取各课程目标的达成度（优先从第3步计算结果获取）
                var objectiveValues = [];
                var overallValue = '0.000';
                
                // 尝试从第3步的计算结果获取
                var achievementsTableBody = document.getElementById('achievements-table-body');
                if (achievementsTableBody) {
                    var rows = achievementsTableBody.querySelectorAll('tr');
                    // 查找"课程目标达成情况"行
                    for (var j = 0; j < rows.length; j++) {
                        var firstCell = rows[j].querySelector('td:first-child');
                        if (firstCell && firstCell.textContent === '课程目标达成情况') {
                            var cells = rows[j].querySelectorAll('td');
                            // 跳过前3个单元格（姓名、平时成绩、考试成绩）
                            for (var k = 3; k < cells.length - 1; k++) {
                                objectiveValues.push(cells[k].textContent);
                            }
                            // 获取总达成度
                            var lastCell = cells[cells.length - 1];
                            if (lastCell) {
                                overallValue = lastCell.textContent;
                            }
                            break;
                        }
                    }
                }
                
                // 如果没有从第3步获取到数据，使用stats.objectiveStats中的值
                if (objectiveValues.length === 0) {
                    stats.objectiveStats.forEach(function(objStat) {
                        objectiveValues.push(objStat.average.toFixed(3));
                    });
                    overallValue = stats.totalAverage.toFixed(3);
                }
                
                // 获取课程目标权重
                var objectiveWeights = [];
                if (window.calculatedObjectives) {
                    objectiveWeights = window.calculatedObjectives.map(function(obj) {
                        return obj.weight || 0;
                    });
                } else {
                    // 如果没有计算权重，从权重结果表格获取
                    var weightResultsBody = document.getElementById('weight-results');
                    if (weightResultsBody) {
                        var weightRows = weightResultsBody.querySelectorAll('tr');
                        weightRows.forEach(function(row) {
                            var weightCell = row.querySelector('td:last-child');
                            if (weightCell) {
                                var weight = parseFloat(weightCell.textContent) || 0;
                                objectiveWeights.push(weight);
                            }
                        });
                    }
                }
                
                // 生成问卷调查数据
                var questionnaireData = generateQuestionnaireData();
                console.log('问卷调查数据:', questionnaireData);
                
                // 生成存在的问题和持续改进的措施
                var problemsAndSolutions = generateProblemsAndSolutions(stats);
                
                // 生成学生成绩数据（附件1）
                var studentScoresData = generateStudentScoresData();
                
                // 生成教师评价表格
                function generateTeacherEvaluationTable(objectiveValues, objectiveWeights, overallValue) {
                    var html = '';
                    var objectiveCount = objectiveValues.length;
                    
                    // 获取全局成绩占比设置
                    var globalDailyPercentageElement = document.getElementById('global-daily-percentage');
                    var globalExamPercentageElement = document.getElementById('global-exam-percentage');
                    var dailyPercentage = globalDailyPercentageElement ? globalDailyPercentageElement.value : '40';
                    var examPercentage = globalExamPercentageElement ? globalExamPercentageElement.value : '60';
                    
                    for (var i = 0; i < objectiveCount; i++) {
                        var objectiveIndex = i + 1;
                        var weight = objectiveWeights[i] || 0;
                        var value = objectiveValues[i] || '0.000';
                        
                        // 获取平时成绩占比
                        var objectiveDailyPercentageElement = document.getElementById('objective-' + objectiveIndex + '-daily-percentage');
                        var objectiveDailyPercentage = objectiveDailyPercentageElement ? objectiveDailyPercentageElement.value : '0';
                        var processPercentage = objectiveDailyPercentage + '%';
                        
                        // 获取期末考试题目占比
                        var questionPercentages = [];
                        var examItemsElement = document.getElementById('objective-' + objectiveIndex + '-exam-items');
                        if (examItemsElement) {
                            var rows = examItemsElement.querySelectorAll('tr');
                            rows.forEach(function(row) {
                                var percentageInput = row.querySelectorAll('input[type="number"]')[2];
                                if (!percentageInput) {
                                    var allInputs = row.querySelectorAll('input');
                                    if (allInputs.length >= 3) {
                                        percentageInput = allInputs[2];
                                    }
                                }
                                if (percentageInput) {
                                    questionPercentages.push(percentageInput.value + '%');
                                } else {
                                    questionPercentages.push('0%');
                                }
                            });
                        }
                        
                        // 确保有4个题目占比
                        while (questionPercentages.length < 4) {
                            questionPercentages.push('0%');
                        }
                        
                        // 课程目标行 - 添加rowspan属性
                        html += '<tr>';
                        html += '<td rowspan="7">课程目标' + objectiveIndex + '</td>';
                        html += '<td rowspan="7">' + weight.toFixed(3) + '</td>';
                        html += '<td rowspan="3">过程性评价（' + dailyPercentage + '%）</td>';
                        html += '<td>课程作业</td>';
                        html += '<td>0.6</td>';
                        html += '<td rowspan="3">' + processPercentage + '</td>';
                        html += '<td rowspan="7">' + value + '</td>';
                        html += '</tr>';
                        
                        // 课堂表现
                        html += '<tr>';
                        html += '<td>课堂表现</td>';
                        html += '<td>0.3</td>';
                        html += '</tr>';
                        
                        // 课堂考勤
                        html += '<tr>';
                        html += '<td>课堂考勤</td>';
                        html += '<td>0.1</td>';
                        html += '</tr>';
                        
                        // 结果性评价 - 第一题
                        html += '<tr>';
                        html += '<td rowspan="4">结果性评价（' + examPercentage + '%）</td>';
                        html += '<td rowspan="4">期末考试</td>';
                        html += '<td>第一题</td>';
                        html += '<td>' + questionPercentages[0] + '</td>';
                        html += '</tr>';
                        
                        // 结果性评价 - 第二题
                        html += '<tr>';
                        html += '<td>第二题</td>';
                        html += '<td>' + questionPercentages[1] + '</td>';
                        html += '</tr>';
                        
                        // 结果性评价 - 第三题
                        html += '<tr>';
                        html += '<td>第三题</td>';
                        html += '<td>' + questionPercentages[2] + '</td>';
                        html += '</tr>';
                        
                        // 结果性评价 - 第四题
                        html += '<tr>';
                        html += '<td>第四题</td>';
                        html += '<td>' + questionPercentages[3] + '</td>';
                        html += '</tr>';
                    }
                    
                    return html;
                }
                
                // 报告模板
                var reportTemplate = `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${courseName}课程目标达成情况评价报告</title>
    <style>
        * {
            font-family: "SimSun", "宋体", serif;
            line-height: 1.5;
            color: #000;
        }
        body {
            font-size: 12pt;
            margin: 20px;
            text-indent: 0;
        }
        h1 {
            font-size: 15pt;
            text-align: center;
            margin: 0;
        }
        h2 {
            font-size: 13pt;
            margin: 0;
            padding-top: 20px;
            padding-bottom: 10px;
        }
        h3, h4 {
            font-size: 12pt;
            margin: 0;
            padding-top: 15px;
            padding-bottom: 5px;
        }
        h5 {
            font-size: 12pt;
            margin: 0;
            text-align: center;
            padding: 10px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-family: "SimSun", "宋体", serif;
            font-size: 10.5pt;
        }
        th, td {
            border: 1px solid #000;
            padding: 6px;
            text-align: left;
            font-family: "SimSun", "宋体", serif;
            font-size: 10.5pt;
        }
        th {
            font-weight: bold;
            background-color: #f0f0f0;
        }
        .info-box {
            margin: 20px 0;
            padding: 15px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
        }
        .appendix {
            margin: 40px 0 0 0;
            padding: 20px 0 0 0;
            border-top: 2px solid #000;
        }
        ul {
            margin: 10px 0 10px 20px;
        }
        li {
            margin: 5px 0;
        }
        p {
            margin: 10px 0;
            text-indent: 2em;
        }
        .center {
            text-align: center;
        }
        .bold {
            font-weight: bold;
        }
        .table-container {
            overflow-x: auto;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <h1>${courseName}课程目标达成情况评价报告</h1>
    
    <div class="info-box">
        <p class="center">班级：${className}      学生人数：${studentCount}     样本数：${actualStudentCount}     评价人：${evaluator}</p>
    </div>
    
    <h2>一、课程目标</h2>
    <p>通过本课程的学习，学生达到以下目标：</p>
    ${generateCourseObjectivesDescriptions()}
    
    <h2>二、课程目标与毕业要求观测点的对应关系</h2>
    <div class="table-container">
        <table>
            <tr>
                <th>课程目标</th>
                <th>支撑的毕业要求</th>
                <th>支撑程度</th>
                <th>支撑的毕业要求指标点</th>
            </tr>
            ${generateCourseObjectivesRelations()}
        </table>
    </div>
    
    <h2>三、课程目标达成度分析</h2>
    <h3>（一）评价方法：定量分析（课程考核的量化成绩，包括过程性考核和结果性考核）与定性分析（学生对于课程学习的主观性评价）</h3>
    
    <h4>1.课程目标定量评价过程与结果</h4>
    <h5>（1）课程教学目标达成评价表</h5>
    <h5>表1  课程教学目标达成评价表</h5>
    <div class="table-container">
        <table>
            ${generateTeachingObjectivesEvaluationTable()}
        </table>
    </div>
    
    <h5>（2）教师评价过程与结果</h5>
    <div class="table-container">
        <table>
            <tr>
                <th>课程目标成绩构成</th>
                <th>权重</th>
                <th>评价环节</th>
                <th>评价环节</th>
                <th>子权重</th>
                <th>环节占比</th>
                <th>分目标达成评价值</th>
            </tr>
            ${generateTeacherEvaluationTable(objectiveValues, objectiveWeights, overallValue)}
        </table>
    </div>
    
    <h4>2. 课程目标定性评价过程与结果</h4>
    <p>采用问卷调查法，运用问卷星设计问卷对学生的课程目标达成情况进行调查，针对课程目标设计的问题及调查统计比例数据如下：</p>
    <div class="table-container">
        <table>
            <tr>
                <th>课程目标</th>
                <th>课程目标达成情况相关问题</th>
                <th>权重</th>
                <th>完全达成</th>
                <th>较好达成</th>
                <th>基本达成</th>
                <th>未达成</th>
                <th>各课程目标达成度</th>
                <th>课程目标达成度</th>
            </tr>
            ${questionnaireData}
        </table>
    </div>
    <p>说明：1.表格中填的百分比为选择该项的人数占全班总人数的百分比。2.问卷题目中的4个选项：完全达成、较好达成、基本达成及未达成各课程目标达成度，分别赋值为95分、85分、70分、60分；因此得到的平均分，即为该题的总体答题情况的平均分。3.将每个课程目标的反馈比例加权求和，再与课程目标赋分比例，得到各个目标的达成值，并根据各课程目标的权重，计算课程目标总的达成值。</p>
    
    <h3>（二）课程目标评价结果</h3>
    <div class="table-container">
        <table>
            <tr>
                <th>项目</th>
                ${generateCourseObjectiveHeaders()}
                <th>整体课程目标</th>
            </tr>
            <tr>
                <td>教师评价（知识+能力）</td>
                ${generateTeacherEvaluationRow(objectiveValues, overallValue)}
            </tr>
            <tr>
                <td>学生评价</td>
                ${generateStudentEvaluationRow()}
            </tr>
        </table>
    </div>
    <p>定量评价结果：${overallValue}，大于合格标准0.7，定性评价结果：${getQualitativeEvaluationResult()}，大于课程目标合格评价标准值0.7，因而课程目标达成。</p>
    
    <h2>四、课程一致性评价和合理性评价分析</h2>
    <h3>（一）一致性评价分析</h3>
    <div class="table-container">
        <table>
            <tr>
                <th>评价内容</th>
                <th>一致</th>
                <th>较一致</th>
                <th>不一致</th>
            </tr>
            <tr>
                <td>学生评价结果与课程评价结果的对比分析</td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
        </table>
    </div>
    
    <h3>（二）合理性评价分析</h3>
    <div class="table-container">
        <table>
            <tr>
                <th>评价内容</th>
                <th>合理</th>
                <th>较合理</th>
                <th>不合理</th>
            </tr>
            <tr>
                <td>课程目标定位</td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <td>课程评价方式（包括考核方式、考核内容、评分标准、与课程目标的关联性）</td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
            <tr>
                <td>课程对毕业要求的支撑指标点和权重</td>
                <td></td>
                <td></td>
                <td></td>
            </tr>
        </table>
    </div>
    
    <h2>五、存在的问题</h2>
    ${problemsAndSolutions.problems}
    
    <h2>六、持续改进的措施</h2>
    ${problemsAndSolutions.solutions}
    
    <div class="appendix">
        <h2>附件1 ${courseName}学生期末成绩及课程目标达成评价值一览表</h2>
        ${studentScoresData}
        
        <h2 style="color: red; margin-top: 40px;">附件2 ${courseName}课程目标达成度学生主观评价调查问卷</h2>
    </div>
</body>
</html>
                `;
                
                return reportTemplate;
            }

            // 生成课程目标描述
            function generateCourseObjectivesDescriptions() {
                var objectives = document.querySelectorAll('.objective-item');
                var descriptions = '';
                
                objectives.forEach(function(obj, index) {
                    var descElement = obj.querySelector('textarea');
                    var reqElement = obj.querySelector('input[type="text"]');
                    var desc = descElement ? descElement.value : '课程目标描述';
                    var req = reqElement ? reqElement.value : '';
                    
                    descriptions += `<p>【课程目标${index + 1}】${desc}${req ? '[' + req + ']' : ''}</p>`;
                });
                
                return descriptions;
            }

            // 生成矩阵关系表
            function generateMatrixTable(objectiveCount) {
                // 调整矩阵表结构，确保子类正确对应到各个大类
                var table = `
                <table>
                    <tr>
                        <th rowspan="2">名称</th>
                        <th colspan="2">践行师德</th>
                        <th colspan="2">学会教学</th>
                        <th colspan="2">学会育人</th>
                        <th colspan="2">学会发展</th>
                    </tr>
                    <tr>
                        <th>师德规范</th>
                        <th>教育情怀</th>
                        <th>保教知识</th>
                        <th>保教能力</th>
                        <th>班级管理</th>
                        <th>综合育人</th>
                        <th>学会反思</th>
                        <th>沟通合作</th>
                    </tr>
                `;
                
                // 添加课程目标行
                for (var i = 1; i <= objectiveCount; i++) {
                    table += `<tr>
                        <td>课程目标${i}</td>
                        ${generateMatrixCells(i, objectiveCount)}
                    </tr>`;
                }
                
                table += `</table>`;
                return table;
            }

            // 生成矩阵表单元格
            function generateMatrixCells(objectiveIndex, totalObjectives) {
                var cells = '';
                // 根据课程目标的实际毕业要求指标点来生成矩阵单元格
                
                // 获取该课程目标的毕业要求指标点
                var requirementElement = document.getElementById('objective-' + objectiveIndex + '-requirement');
                var requirement = requirementElement ? requirementElement.value : '';
                
                // 定义各个子类的关键词
                var categories = [
                    '师德规范', '教育情怀',      // 践行师德
                    '保教知识', '保教能力',      // 学会教学
                    '班级管理', '综合育人',      // 学会育人
                    '学会反思', '沟通合作'       // 学会发展
                ];
                
                // 为每个子类生成单元格
                for (var j = 0; j < categories.length; j++) {
                    // 检查毕业要求中是否包含该子类的关键词
                    if (requirement.includes(categories[j]) || 
                        (categories[j] === '保教知识' && (requirement.includes('保教知识') || requirement.includes('3.1') || requirement.includes('3.2') || requirement.includes('3.3'))) ||
                        (categories[j] === '保教能力' && (requirement.includes('保教能力') || requirement.includes('4.1') || requirement.includes('4.2'))) ||
                        (categories[j] === '综合育人' && (requirement.includes('综合育人') || requirement.includes('6.1') || requirement.includes('6.2') || requirement.includes('6.3')))) {
                        cells += '<td>*</td>';
                    } else {
                        cells += '<td></td>';
                    }
                }
                return cells;
            }

            // 生成评价表
            function generateEvaluationTable(objectiveCount, objectiveValues) {
                var table = `
                <table>
                    <tr>
                        <th>项目</th>
                        ${generateObjectiveHeaders(objectiveCount)}
                    </tr>
                    <tr>
                        <td>对应的毕业要求指标点</td>
                        ${generateRequirementPoints(objectiveCount)}
                    </tr>
                    <tr>
                        <td>评价方式</td>
                        ${Array(objectiveCount).fill('<td>定量+定性</td>').join('')}
                    </tr>
                    <tr>
                        <td>评价内容</td>
                        ${generateEvaluationContents(objectiveCount)}
                    </tr>
                    <tr>
                        <td>期望值</td>
                        ${Array(objectiveCount).fill('<td>0.7</td>').join('')}
                    </tr>
                </table>
                `;
                return table;
            }

            // 生成课程目标表头
            function generateObjectiveHeaders(objectiveCount) {
                var headers = '';
                for (var i = 1; i <= objectiveCount; i++) {
                    headers += `<th>课程目标${i}</th>`;
                }
                return headers;
            }

            // 生成毕业要求指标点
            function generateRequirementPoints(objectiveCount) {
                var points = '';
                for (var i = 1; i <= objectiveCount; i++) {
                    // 从第1步的课程目标设置中获取毕业要求指标点
                    var requirementElement = document.getElementById('objective-' + i + '-requirement');
                    var requirement = requirementElement ? requirementElement.value : '毕业要求[M]';
                    points += '<td>' + requirement + '</td>';
                }
                return points;
            }

            // 生成评价内容
            function generateEvaluationContents(objectiveCount) {
                var contents = '';
                for (var i = 1; i <= objectiveCount; i++) {
                    // 从第2步的权重设置中获取评价内容
                    var dailyPercentageElement = document.getElementById('objective-' + i + '-daily-percentage');
                    var dailyPercentage = dailyPercentageElement ? dailyPercentageElement.value : '0';
                    
                    // 获取期末考试题目设置
                    var examItemsElement = document.getElementById('objective-' + i + '-exam-items');
                    var examItems = '';
                    if (examItemsElement) {
                        var rows = examItemsElement.querySelectorAll('tr');
                        if (rows.length > 0) {
                                examItems = '<br>期末成绩：';
                                rows.forEach(function(row, index) {
                                    var nameInput = row.querySelector('.question-name');
                                    var percentageInput = row.querySelectorAll('input[type="number"]')[1];
                                    if (nameInput && percentageInput) {
                                        var questionName = nameInput.value;
                                        var percentage = percentageInput.value;
                                        examItems += questionName + '（' + percentage + '%）+ ';
                                    }
                                });
                                examItems = examItems.slice(0, -2); // 移除最后的 " + "
                            }
                    }
                    
                    contents += '<td>平时成绩（' + dailyPercentage + '%）+' + examItems + '</td>';
                }
                return contents;
            }

            // 生成权重列表
            function generateWeightsList() {
                // 从计算结果中获取权重
                if (window.calculatedObjectives) {
                    var weights = window.calculatedObjectives.map(function(obj) {
                        return obj.weight.toFixed(3);
                    });
                    return weights.join('，');
                }
                // 简化版，实际应用中可能需要从计算结果中获取
                return '0.325，0.35，0.325';
            }

            // 生成存在的问题及整改措施
            function generateProblemsAndSolutions(stats) {
                console.log('generateProblemsAndSolutions 函数被调用，stats:', stats);
                
                // 获取课程目标的具体内容
                var objectives = document.querySelectorAll('.objective-item');
                var objectiveContents = [];
                objectives.forEach(function(obj, index) {
                    var descElement = obj.querySelector('textarea');
                    var desc = descElement ? descElement.value : '课程目标描述';
                    objectiveContents.push(desc);
                });
                
                // 分析各课程目标的达成情况
                var objectiveProblems = [];
                var objectiveSolutions = [];
                
                stats.objectiveStats.forEach(function(objStat, index) {
                    var objectiveIndex = index + 1;
                    var average = objStat.average;
                    var passRate = objStat.passRate;
                    var excellentRate = objStat.excellentRate;
                    var achievementCount = objStat.achievements.length;
                    
                    // 分析学生达成度分布
                    var lowAchievers = objStat.achievements.filter(a => a < 0.7).length;
                    var middleAchievers = objStat.achievements.filter(a => a >= 0.7 && a < 0.85).length;
                    var highAchievers = objStat.achievements.filter(a => a >= 0.85).length;
                    
                    console.log('课程目标' + objectiveIndex + '达成度:', average, '合格率:', passRate, '优秀率:', excellentRate);
                    console.log('低达成度学生数:', lowAchievers, '中等达成度学生数:', middleAchievers, '高达成度学生数:', highAchievers);
                    
                    // 获取课程目标的具体内容关键词
                    var objectiveContent = objectiveContents[index] || '';
                    var contentKeywords = [];
                    if (objectiveContent.includes('基础知识')) contentKeywords.push('基础知识');
                    if (objectiveContent.includes('实践能力')) contentKeywords.push('实践能力');
                    if (objectiveContent.includes('综合应用')) contentKeywords.push('综合应用');
                    if (objectiveContent.includes('创新能力')) contentKeywords.push('创新能力');
                    if (objectiveContent.includes('分析能力')) contentKeywords.push('分析能力');
                    if (objectiveContent.includes('解决问题')) contentKeywords.push('解决问题能力');
                    if (contentKeywords.length === 0) contentKeywords.push('核心内容');
                    
                    // 根据达成度生成具体问题
                    if (average < 0.7) {
                        objectiveProblems.push(`课程目标${objectiveIndex}达成度偏低（${average.toFixed(2)}），具体表现为：1. 学生对${contentKeywords.join('、')}的掌握不够扎实，基础薄弱；2. ${lowAchievers}名学生（占比${(lowAchievers/achievementCount*100).toFixed(1)}%）未能达到基本要求，存在明显的学习困难；3. 学生在课堂参与度和课后作业完成质量方面表现较差，学习态度需要改进；4. 知识应用能力不足，无法将所学内容与实际情境相结合。`);
                        objectiveSolutions.push(`针对课程目标${objectiveIndex}的具体改进措施：1. 加强${contentKeywords.join('、')}的教学，采用分层教学方法，为基础薄弱学生提供额外辅导；2. 增加课堂互动和实践环节，提高学生的参与度和学习积极性；3. 设计更加贴近实际的作业和练习，强化知识应用能力；4. 建立学习跟踪机制，定期检测学生的学习进展，及时调整教学策略。`);
                    } else if (average < 0.85) {
                        objectiveProblems.push(`课程目标${objectiveIndex}达成度一般（${average.toFixed(2)}），具体表现为：1. 大部分学生能够掌握基本内容，但在${contentKeywords.join('、')}的深度和广度方面有待提升；2. ${middleAchievers}名学生（占比${(middleAchievers/achievementCount*100).toFixed(1)}%）处于中等水平，需要进一步提高；3. 学生的知识迁移能力和综合应用能力较弱，难以应对复杂问题；4. 部分学生学习方法不当，缺乏自主学习能力和学习策略。`);
                        objectiveSolutions.push(`针对课程目标${objectiveIndex}的具体改进措施：1. 深化${contentKeywords.join('、')}的教学内容，增加拓展性和挑战性任务；2. 采用项目式学习和小组合作学习等方法，培养学生的综合应用能力；3. 开展学习方法指导，帮助学生掌握有效的学习策略；4. 建立学习激励机制，鼓励学生积极参与课堂讨论和课外活动。`);
                    } else {
                        objectiveProblems.push(`课程目标${objectiveIndex}达成度良好（${average.toFixed(2)}），但仍存在以下问题：1. 部分学生在${contentKeywords.join('、')}的高层次应用方面有待提升，如分析、评价和创造能力；2. ${highAchievers}名学生（占比${(highAchievers/achievementCount*100).toFixed(1)}%）表现优秀，但缺乏进一步发展的空间；3. 学生对前沿知识和最新研究成果的了解不够，视野需要拓宽；4. 跨学科知识整合能力较弱，难以将不同领域的知识融会贯通。`);
                        objectiveSolutions.push(`针对课程目标${objectiveIndex}的具体改进措施：1. 设计开放性和探究性学习任务，培养学生的高层次思维能力；2. 为优秀学生提供更具挑战性的学习内容和研究机会；3. 定期引入前沿知识和最新研究成果，拓宽学生的视野；4. 开展跨学科项目合作，提高学生的知识整合能力。`);
                    }
                });
                
                // 分析整体达成情况
                var overallAverage = stats.totalAverage;
                var passRate = stats.passRate;
                var excellentRate = stats.excellentRate;
                var studentCount = stats.overallAchievements.length;
                
                console.log('整体达成度:', overallAverage, '合格率:', passRate, '优秀率:', excellentRate, '学生人数:', studentCount);
                
                // 分析个体差异
                var sortedAchievements = [...stats.overallAchievements].sort(function(a, b) { return a - b; });
                var minAchievement = sortedAchievements[0];
                var maxAchievement = sortedAchievements[sortedAchievements.length - 1];
                var achievementRange = maxAchievement - minAchievement;
                
                // 分析成绩分布
                var overallLowAchievers = stats.overallAchievements.filter(a => a < 0.7).length;
                var overallMiddleAchievers = stats.overallAchievements.filter(a => a >= 0.7 && a < 0.85).length;
                var overallHighAchievers = stats.overallAchievements.filter(a => a >= 0.85).length;
                
                console.log('整体低达成度学生数:', overallLowAchievers, '中等达成度学生数:', overallMiddleAchievers, '高达成度学生数:', overallHighAchievers);
                
                // 生成问题列表
                var problems = `<div>`;
                
                // 添加针对各课程目标的问题
                objectiveProblems.forEach(function(problem, index) {
                    problems += `<p>${problem}</p>`;
                });
                
                // 添加综合性问题
                if (overallLowAchievers > 0) {
                    problems += `<p>存在${overallLowAchievers}名学生（占比${(overallLowAchievers/studentCount*100).toFixed(1)}%）未达到基本要求，具体问题包括：1. 学习态度不端正，出勤率和作业完成率低；2. 学习基础薄弱，跟不上教学进度；3. 学习方法不当，缺乏自主学习能力；4. 对课程内容缺乏兴趣，学习动力不足。</p>`;
                }
                
                if (overallMiddleAchievers > studentCount * 0.6) {
                    problems += `<p>大部分学生（${overallMiddleAchievers}名，占比${(overallMiddleAchievers/studentCount*100).toFixed(1)}%）处于中等水平，具体问题包括：1. 学习目标不明确，缺乏学习动力；2. 知识掌握不够扎实，存在漏洞；3. 应用能力不足，无法将所学知识转化为实际技能；4. 缺乏学习策略，学习效率不高。</p>`;
                }
                
                if (overallHighAchievers < studentCount * 0.2) {
                    problems += `<p>优秀学生比例偏低（${overallHighAchievers}名，占比${(overallHighAchievers/studentCount*100).toFixed(1)}%），具体问题包括：1. 教学内容深度和广度不够，难以满足优秀学生的学习需求；2. 缺乏挑战性任务和拓展性学习机会；3. 评价方式单一，无法全面反映学生的能力和潜力；4. 优秀学生之间缺乏交流和合作的平台。</p>`;
                }
                
                if (achievementRange > 0.4) {
                    problems += `<p>学生个体差异较大（最低${minAchievement.toFixed(2)}，最高${maxAchievement.toFixed(2)}，差距${achievementRange.toFixed(2)}），具体问题包括：1. 学生学习基础和能力水平差异显著；2. 教学内容和方法未能充分考虑个体差异；3. 学习资源分配不均，部分学生获得的支持不足；4. 班级整体学习氛围受到影响，难以形成良好的学习共同体。</p>`;
                }
                
                // 分析学习投入情况
                problems += `<p>学习投入与产出不匹配，具体问题包括：1. 部分学生课堂参与度低，缺乏主动思考和提问；2. 课后复习和预习不充分，知识巩固效果不佳；3. 学习资源利用不足，如教材、参考资料和在线资源；4. 缺乏学习反思和总结，难以形成有效的知识体系。</p>`;
                
                problems += `</div>`;
                
                // 生成整改措施列表
                var solutions = `<div>`;
                
                // 添加针对各课程目标的整改措施
                objectiveSolutions.forEach(function(solution, index) {
                    solutions += `<p>${solution}</p>`;
                });
                
                // 添加综合性整改措施
                if (overallLowAchievers > 0) {
                    solutions += `<p>针对未达基本要求学生的改进措施：1. 建立学习预警机制，及时识别和帮助学习困难学生；2. 开展一对一辅导，针对学生的具体问题提供个性化帮助；3. 设计基础强化课程，帮助学生补齐知识漏洞；4. 加强学习动机激发，帮助学生建立学习信心和目标。</p>`;
                }
                
                if (overallMiddleAchievers > studentCount * 0.6) {
                    solutions += `<p>针对中等水平学生的改进措施：1. 设立分层学习目标，鼓励学生逐步提升；2. 提供进阶学习资源，满足学生的学习需求；3. 开展学习方法培训，帮助学生掌握有效的学习策略；4. 建立学习小组，促进学生之间的相互学习和交流。</p>`;
                }
                
                if (overallHighAchievers < studentCount * 0.2) {
                    solutions += `<p>针对优秀学生的改进措施：1. 开发拓展性课程模块，为优秀学生提供更具挑战性的学习内容；2. 设立学科竞赛和创新项目，鼓励学生积极参与；3. 建立导师制，为优秀学生提供个性化的学术指导；4. 组织学术讲座和研讨活动，拓宽学生的学术视野。</p>`;
                }
                
                if (achievementRange > 0.4) {
                    solutions += `<p>针对个体差异较大的改进措施：1. 实施差异化教学，根据学生的学习能力和需求调整教学内容和方法；2. 建立个性化学习计划，为每个学生制定适合的学习路径；3. 丰富学习资源，提供多层次的学习材料；4. 加强班级建设，营造互帮互助的学习氛围。</p>`;
                }
                
                // 添加通用整改措施
                solutions += `<p>通用改进措施：1. 优化课程设计，根据课程目标的具体要求调整教学内容和方法；2. 加强课堂教学改革，采用多种教学方法提高学生的参与度和学习效果；3. 完善评价体系，采用多元化的评价方式全面反映学生的学习成果；4. 加强学习支持服务，为学生提供全方位的学习帮助；5. 建立教学反馈机制，定期收集学生的意见和建议，持续改进教学质量；6. 利用现代教育技术，丰富教学手段，提高教学效率和效果；7. 加强与其他课程的衔接，形成完整的课程体系，促进知识的融会贯通。</p>`;
                
                solutions += `</div>`;
                
                console.log('生成的问题:', problems);
                console.log('生成的整改措施:', solutions);
                
                return { problems: problems, solutions: solutions };
            }

            // 生成学生成绩录入表格（附录1）
            function generateStudentScoresTable() {
                var studentsTableBody = document.getElementById('students-table-body');
                var tableHeader = document.getElementById('students-table-header');
                if (!studentsTableBody || !tableHeader) {
                    return '<p>（无学生成绩数据）</p>';
                }
                
                // 获取表头
                var headerRow = tableHeader.querySelector('tr');
                var headerCells = headerRow.querySelectorAll('th');
                var headerHTML = '<tr>';
                // 添加序号列表头
                headerHTML += '<th>序号</th>';
                // 添加其他表头（排除操作列）
                for (var i = 0; i < headerCells.length - 1; i++) {
                    headerHTML += '<th>' + headerCells[i].textContent + '</th>';
                }
                headerHTML += '</tr>';
                
                // 获取学生数据
                var studentRows = studentsTableBody.querySelectorAll('tr');
                var dataRowsHTML = '';
                studentRows.forEach(function(row, index) {
                    var inputs = row.querySelectorAll('input');
                    if (inputs.length < 3) return;
                    
                    dataRowsHTML += '<tr>';
                    // 添加序号
                    dataRowsHTML += '<td>' + (index + 1) + '</td>';
                    // 添加学生姓名
                    dataRowsHTML += '<td>' + (inputs[0].value || '未命名') + '</td>';
                    // 添加平时成绩
                    dataRowsHTML += '<td>' + (inputs[1].value || '0') + '</td>';
                    // 添加期末成绩
                    dataRowsHTML += '<td>' + (inputs[2].value || '0') + '</td>';
                    // 添加期末考试题目得分
                    var questionInputs = Array.from(inputs).slice(3);
                    questionInputs.forEach(function(input) {
                        dataRowsHTML += '<td>' + (input.value || '0') + '</td>';
                    });
                    dataRowsHTML += '</tr>';
                });
                
                // 添加平均分（如果有）
                var tableFooter = document.getElementById('students-table-footer');
                var footerHTML = '';
                if (tableFooter) {
                    var footerRow = tableFooter.querySelector('tr');
                    var footerCells = footerRow.querySelectorAll('td');
                    footerHTML = '<tr>';
                    // 最后一行不写序号
                    footerHTML += '<td></td>';
                    // 添加其他分（排除操作列）
                    for (var i = 0; i < footerCells.length - 1; i++) {
                        footerHTML += '<td>' + footerCells[i].innerHTML + '</td>';
                    }
                    footerHTML += '</tr>';
                }
                
                return '<table>' + headerHTML + dataRowsHTML + footerHTML + '</table>';
            }
            
            // 生成课程目标达成明细表（附录2）
            function generateAchievementsTable() {
                var achievementsTableBody = document.getElementById('achievements-table-body');
                var tableHeader = document.getElementById('achievements-table-header');
                if (!achievementsTableBody || !tableHeader) {
                    return '<p>（无达成度数据）</p>';
                }
                
                // 获取表头
                var headerRow = tableHeader.querySelector('tr');
                var headerCells = headerRow.querySelectorAll('th');
                var headerHTML = '<tr>';
                // 添加序号列表头
                headerHTML += '<th>序号</th>';
                // 添加其他表头
                headerCells.forEach(function(cell) {
                    headerHTML += '<th>' + cell.textContent + '</th>';
                });
                headerHTML += '</tr>';
                
                // 获取达成度数据
                var achievementRows = achievementsTableBody.querySelectorAll('tr');
                var dataRowsHTML = '';
                var totalRows = achievementRows.length;
                var studentCount = 0;
                
                achievementRows.forEach(function(row, index) {
                    var cells = row.querySelectorAll('td');
                    if (cells.length < 3) return;
                    
                    // 判断是否为最后一行（课程目标达成情况行）
                    var isLastRow = (index === totalRows - 1);
                    
                    dataRowsHTML += '<tr>';
                    // 最后一行不写序号
                    if (!isLastRow) {
                        dataRowsHTML += '<td>' + (studentCount + 1) + '</td>';
                        studentCount++;
                    } else {
                        dataRowsHTML += '<td></td>';
                    }
                    // 添加其他单元格数据
                    cells.forEach(function(cell) {
                        dataRowsHTML += '<td>' + cell.textContent + '</td>';
                    });
                    dataRowsHTML += '</tr>';
                });
                
                return '<div style="page-break-before: always;"></div><table>' + headerHTML + dataRowsHTML + '</table>';
            }
            
            // 生成学生成绩数据（附件1）
            function generateStudentScoresData() {
                var studentsTableBody = document.getElementById('students-table-body');
                if (!studentsTableBody) {
                    return '<p>（无学生成绩数据）</p>';
                }
                
                var studentRows = studentsTableBody.querySelectorAll('tr');
                if (studentRows.length === 0) {
                    return '<p>（无学生成绩数据）</p>';
                }
                
                var html = '<div class="table-container"><table>';
                html += '<tr>';
                html += '<th>序号</th>';
                html += '<th>姓名</th>';
                html += '<th>平时成绩(40%)</th>';
                html += '<th>考试成绩(60%)</th>';
                
                // 动态生成课程目标达成评价值列
                var objectiveCount = document.querySelectorAll('.objective-item').length;
                for (var i = 1; i <= objectiveCount; i++) {
                    html += '<th>目标' + i + '达成评价值</th>';
                }
                
                html += '<th>总目标达成评价值</th>';
                html += '</tr>';
                
                studentRows.forEach(function(row, index) {
                    var inputs = row.querySelectorAll('input');
                    if (inputs.length < 3) return;
                    
                    var name = inputs[0].value || '未命名';
                    var dailyScore = inputs[1].value || '0';
                    var examScore = inputs[2].value || '0';
                    
                    // 模拟目标达成评价值（实际应用中应从达成度数据中获取）
                    var objectiveCount = document.querySelectorAll('.objective-item').length;
                    var objValues = [];
                    var weights = [];
                    
                    // 生成每个课程目标的达成评价值
                    for (var i = 0; i < objectiveCount; i++) {
                        // 根据不同目标生成不同范围的随机值
                        var baseValue = 0.6 + (i * 0.05);
                        var randomValue = (Math.random() * 0.3 + baseValue).toFixed(3);
                        objValues.push(randomValue);
                        // 生成权重（实际应用中应从计算结果中获取）
                        weights.push(1 / objectiveCount);
                    }
                    
                    // 计算总目标达成评价值
                    var total = 0;
                    for (var i = 0; i < objectiveCount; i++) {
                        total += parseFloat(objValues[i]) * weights[i];
                    }
                    total = total.toFixed(3);
                    
                    html += '<tr>';
                    html += '<td>' + (index + 1) + '</td>';
                    html += '<td>' + name + '</td>';
                    html += '<td>' + dailyScore + '</td>';
                    html += '<td>' + examScore + '</td>';
                    
                    // 动态生成课程目标达成评价值单元格
                    for (var i = 0; i < objectiveCount; i++) {
                        html += '<td>' + objValues[i] + '</td>';
                    }
                    
                    html += '<td>' + total + '</td>';
                    html += '</tr>';
                    
                });
                
                html += '</table></div>';
                return html;
            }
            
            // 生成问卷调查数据
            function generateQuestionnaireData() {
                var html = '';
                var questionnaireTableBody = document.getElementById('questionnaire-table-body');
                
                if (questionnaireTableBody) {
                    var rows = questionnaireTableBody.querySelectorAll('tr');
                    var rowCount = rows.length;
                    
                    if (rowCount > 0) {
                        rows.forEach(function(row, index) {
                            var cells = row.querySelectorAll('td');
                            if (cells.length >= 9) {
                                // 课程目标
                                var courseObjective = cells[0].textContent;
                                
                                // 问题内容
                                var questionInput = row.querySelector('td:nth-child(2) input');
                                var question = questionInput ? questionInput.value : '请输入课程目标达成情况相关问题';
                                
                                // 权重
                                var weight = cells[2].textContent;
                                
                                // 各选项比例 - 直接使用用户输入的数值并保留两位小数
                                // 直接使用外部已经定义的 cells 变量
                                var fullyAchievedInput = cells[3] ? cells[3].querySelector('input') : null;
                                var wellAchievedInput = cells[4] ? cells[4].querySelector('input') : null;
                                var basicallyAchievedInput = cells[5] ? cells[5].querySelector('input') : null;
                                var notAchievedInput = cells[6] ? cells[6].querySelector('input') : null;
                                
                                // 获取输入值
                                var fullyAchievedValue = fullyAchievedInput ? fullyAchievedInput.value : '0';
                                var wellAchievedValue = wellAchievedInput ? wellAchievedInput.value : '0';
                                var basicallyAchievedValue = basicallyAchievedInput ? basicallyAchievedInput.value : '0';
                                var notAchievedValue = notAchievedInput ? notAchievedInput.value : '0';
                                
                                // 转换为数值并保留两位小数
                                var fullyAchieved = parseFloat(fullyAchievedValue) || 0;
                                var wellAchieved = parseFloat(wellAchievedValue) || 0;
                                var basicallyAchieved = parseFloat(basicallyAchievedValue) || 0;
                                var notAchieved = parseFloat(notAchievedValue) || 0;
                                
                                // 保留两位小数并添加百分号
                                var fullyAchievedRatio = fullyAchieved.toFixed(2) + '%';
                                var wellAchievedRatio = wellAchieved.toFixed(2) + '%';
                                var basicallyAchievedRatio = basicallyAchieved.toFixed(2) + '%';
                                var notAchievedRatio = notAchieved.toFixed(2) + '%';
                                
                                // 添加调试信息
                                console.log('课程目标:', courseObjective);
                                console.log('输入值 - 完全达成:', fullyAchievedValue, '转换后:', fullyAchieved, '显示:', fullyAchievedRatio);
                                console.log('输入值 - 较好达成:', wellAchievedValue, '转换后:', wellAchieved, '显示:', wellAchievedRatio);
                                console.log('输入值 - 基本达成:', basicallyAchievedValue, '转换后:', basicallyAchieved, '显示:', basicallyAchievedRatio);
                                console.log('输入值 - 未达成:', notAchievedValue, '转换后:', notAchieved, '显示:', notAchievedRatio);
                                
                                // 确保获取的是"各课程目标达成度"列的数据
                                var objectiveAchievementCell = row.querySelector('.objective-achievement');
                                var objectiveAchievement = objectiveAchievementCell ? objectiveAchievementCell.textContent : '0.000';
                                
                                // 确保获取的是"课程目标达成度"列的数据
                                var totalAchievementCell = row.querySelector('.total-achievement');
                                var totalAchievement = totalAchievementCell ? totalAchievementCell.textContent : '0.000';
                                
                                html += '<tr>';
                                html += '<td>' + courseObjective + '</td>';
                                html += '<td>' + question + '</td>';
                                html += '<td>' + weight + '</td>';
                                html += '<td>' + fullyAchievedRatio + '</td>';
                                html += '<td>' + wellAchievedRatio + '</td>';
                                html += '<td>' + basicallyAchievedRatio + '</td>';
                                html += '<td>' + notAchievedRatio + '</td>';
                                html += '<td>' + objectiveAchievement + '</td>';
                                
                                // 只在第一行显示总达成度并合并单元格
                                if (index === 0) {
                                    html += '<td rowspan="' + rowCount + '">' + totalAchievement + '</td>';
                                }
                                
                                html += '</tr>';
                            }
                        });
                    } else {
                        // 如果没有问卷调查数据，显示默认数据
                        html += '<tr>';
                        html += '<td>课程目标1</td>';
                        html += '<td>掌握常微分方程的基本概念；几类一阶微分方程的求解；以及微分方程的基本理论和求解微分方程的基本方法。</td>';
                        html += '<td>0.50</td>';
                        html += '<td>56.99%</td>';
                        html += '<td>38.98%</td>';
                        html += '<td>3.50%</td>';
                        html += '<td>0.54%</td>';
                        html += '<td>0.900</td>';
                        html += '<td rowspan="3">0.904</td>';
                        html += '</tr>';
                        html += '<tr>';
                        html += '<td>课程目标2</td>';
                        html += '<td>理解常微分方程课程内容、注重常微分方程课程对中学数学教学指导作用的研究与实践，课程学习中能突出所教内容与初等数学的联系及其对中学数学教学的指导作用。</td>';
                        html += '<td>0.17</td>';
                        html += '<td>62.01%</td>';
                        html += '<td>33.33%</td>';
                        html += '<td>3.94%</td>';
                        html += '<td>0.72%</td>';
                        html += '<td>0.904</td>';
                        html += '</tr>';
                        html += '<tr>';
                        html += '<td>课程目标3</td>';
                        html += '<td>学生是否具有适合自己的学习方法和积极的学习心态，是否具有发现问题、反思问题的能力。</td>';
                        html += '<td>0.33</td>';
                        html += '<td>64.52%</td>';
                        html += '<td>32.53%</td>';
                        html += '<td>2.16%</td>';
                        html += '<td>0.81%</td>';
                        html += '<td>0.909</td>';
                        html += '</tr>';
                    }
                } else {
                    // 如果没有问卷调查表格，显示默认数据
                    html += '<tr>';
                    html += '<td>课程目标1</td>';
                    html += '<td>掌握常微分方程的基本概念；几类一阶微分方程的求解；以及微分方程的基本理论和求解微分方程的基本方法。</td>';
                    html += '<td>0.50</td>';
                    html += '<td>56.99%</td>';
                    html += '<td>38.98%</td>';
                    html += '<td>3.50%</td>';
                    html += '<td>0.54%</td>';
                    html += '<td>0.900</td>';
                    html += '<td rowspan="3">0.904</td>';
                    html += '</tr>';
                    html += '<tr>';
                    html += '<td>课程目标2</td>';
                    html += '<td>理解常微分方程课程内容、注重常微分方程课程对中学数学教学指导作用的研究与实践，课程学习中能突出所教内容与初等数学的联系及其对中学数学教学的指导作用。</td>';
                    html += '<td>0.17</td>';
                    html += '<td>62.01%</td>';
                    html += '<td>33.33%</td>';
                    html += '<td>3.94%</td>';
                    html += '<td>0.72%</td>';
                    html += '<td>0.904</td>';
                    html += '</tr>';
                    html += '<tr>';
                    html += '<td>课程目标3</td>';
                    html += '<td>学生是否具有适合自己的学习方法和积极的学习心态，是否具有发现问题、反思问题的能力。</td>';
                    html += '<td>0.33</td>';
                    html += '<td>64.52%</td>';
                    html += '<td>32.53%</td>';
                    html += '<td>2.16%</td>';
                    html += '<td>0.81%</td>';
                    html += '<td>0.909</td>';
                    html += '</tr>';
                }
                
                return html;
            }
            
            // 生成学生评价行
            function generateStudentEvaluationRow() {
                var html = '';
                var questionnaireTableBody = document.getElementById('questionnaire-table-body');
                var totalAchievement = '0.000';
                var hasData = false;
                
                if (questionnaireTableBody) {
                    var rows = questionnaireTableBody.querySelectorAll('tr');
                    
                    if (rows.length > 0) {
                        rows.forEach(function(row, index) {
                            var cells = row.querySelectorAll('td');
                            if (cells.length >= 8) {
                                // 确保获取的是"各课程目标达成度"列的数据
                                var objectiveAchievementCell = row.querySelector('.objective-achievement');
                                var objectiveAchievement = objectiveAchievementCell ? objectiveAchievementCell.textContent : '0.000';
                                html += '<td>' + objectiveAchievement + '</td>';
                                hasData = true;
                            }
                            
                            // 获取总达成度
                            if (index === 0 && cells.length >= 9) {
                                var totalAchievementCell = row.querySelector('.total-achievement');
                                totalAchievement = totalAchievementCell ? totalAchievementCell.textContent : '0.000';
                            }
                        });
                        
                        // 添加总达成度单元格
                        html += '<td>' + totalAchievement + '</td>';
                    }
                }
                
                // 如果没有获取到数据，使用默认值
                if (!hasData) {
                    html += '<td>0.900</td><td>0.904</td><td>0.909</td><td>0.904</td>';
                }
                
                return html;
            }
            
            // 生成课程目标评价结果表格的表头
            function generateCourseObjectiveHeaders() {
                var html = '';
                var objectiveCount = document.querySelectorAll('.objective-item').length;
                
                for (var i = 1; i <= objectiveCount; i++) {
                    html += '<th>课程目标' + i + '</th>';
                }
                
                return html;
            }
            
            // 生成教师评价行
            function generateTeacherEvaluationRow(objectiveValues, overallValue) {
                var html = '';
                var objectiveCount = document.querySelectorAll('.objective-item').length;
                
                for (var i = 0; i < objectiveCount; i++) {
                    html += '<td>' + (objectiveValues[i] || '0.000') + '</td>';
                }
                
                html += '<td>' + overallValue + '</td>';
                
                return html;
            }
            
            // 获取定性评价结果
            function getQualitativeEvaluationResult() {
                var questionnaireTableBody = document.getElementById('questionnaire-table-body');
                
                if (questionnaireTableBody) {
                    var rows = questionnaireTableBody.querySelectorAll('tr');
                    if (rows.length > 0) {
                        var firstRow = rows[0];
                        // 确保获取的是"课程目标达成度"列的数据
                        var totalAchievementCell = firstRow.querySelector('.total-achievement');
                        if (totalAchievementCell) {
                            return totalAchievementCell.textContent;
                        }
                    }
                }
                
                // 默认值
                return '0.904';
            }
            
            // 生成课程目标与毕业要求观测点的对应关系
            function generateCourseObjectivesRelations() {
                var objectives = document.querySelectorAll('.objective-item');
                var html = '';
                
                objectives.forEach(function(obj, index) {
                    var objectiveIndex = index + 1;
                    
                    // 获取课程目标信息
                    var reqElement = obj.querySelector('input[type="text"]');
                    var supportElement = obj.querySelector('select');
                    var specificReqElement = obj.querySelectorAll('textarea')[1];
                    
                    var req = reqElement ? reqElement.value : '';
                    var support = supportElement ? supportElement.value : 'M';
                    var specificReq = specificReqElement ? specificReqElement.value : '';
                    
                    // 提取毕业要求编号和名称
                    var reqNumber = '';
                    var reqName = '';
                    var reqMatch = req.match(/毕业要求(\d+)：(.+)/);
                    if (reqMatch) {
                        reqNumber = reqMatch[1];
                        reqName = reqMatch[2];
                    }
                    
                    // 分割具体指标点描述
                    var specificReqLines = specificReq.split('\n').filter(function(line) { return line.trim() !== ''; });
                    var specificReqCount = specificReqLines.length;
                    
                    // 生成表格行
                    if (specificReqCount > 0) {
                        // 第一行（包含课程目标、毕业要求和支撑程度）
                        html += '<tr>';
                        html += '<td rowspan="' + specificReqCount + '">课程目标' + objectiveIndex + '</td>';
                        html += '<td rowspan="' + specificReqCount + '">毕业要求' + reqNumber + (reqName ? reqName : '') + '</td>';
                        html += '<td rowspan="' + specificReqCount + '">' + support + '</td>';
                        html += '<td>' + specificReqLines[0] + '</td>';
                        html += '</tr>';
                        
                        // 后续行（只包含具体指标点描述）
                        for (var i = 1; i < specificReqCount; i++) {
                            html += '<tr>';
                            html += '<td>' + specificReqLines[i] + '</td>';
                            html += '</tr>';
                        }
                    } else {
                        // 没有具体指标点描述时生成一行
                        html += '<tr>';
                        html += '<td>课程目标' + objectiveIndex + '</td>';
                        html += '<td>毕业要求' + reqNumber + (reqName ? reqName : '') + '</td>';
                        html += '<td>' + support + '</td>';
                        html += '<td>（无具体指标点描述）</td>';
                        html += '</tr>';
                    }
                });
                
                return html;
            }
            
            // 生成课程教学目标达成评价表
            function generateTeachingObjectivesEvaluationTable() {
                var objectives = document.querySelectorAll('.objective-item');
                var html = '';
                
                // 收集所有课程目标的信息
                var objectiveInfos = [];
                
                objectives.forEach(function(obj, index) {
                    var objectiveIndex = index + 1;
                    
                    // 获取课程目标信息
                    var reqElement = obj.querySelector('input[type="text"]');
                    var supportElement = obj.querySelector('select');
                    var specificReqElement = obj.querySelectorAll('textarea')[1];
                    
                    var req = reqElement ? reqElement.value : '';
                    var support = supportElement ? supportElement.value : 'M';
                    var specificReq = specificReqElement ? specificReqElement.value : '';
                    
                    // 提取毕业要求编号和名称
                    var reqNumber = '';
                    var reqName = '';
                    var reqMatch = req.match(/毕业要求(\d+)：(.+)/);
                    if (reqMatch) {
                        reqNumber = reqMatch[1];
                        reqName = reqMatch[2];
                    }
                    
                    // 提取指标点名称
                    var indicatorNames = [];
                    var specificReqLines = specificReq.split('\n').filter(function(line) { return line.trim() !== ''; });
                    
                    specificReqLines.forEach(function(line) {
                        var indicatorMatch = line.match(/\d+\.\d+【(.+)】/);
                        if (indicatorMatch) {
                            var indicatorName = indicatorMatch[1];
                            indicatorNames.push(indicatorName);
                        }
                    });
                    
                    objectiveInfos.push({
                        index: objectiveIndex,
                        req: req,
                        reqName: reqName,
                        support: support,
                        indicatorNames: indicatorNames
                    });
                });
                
                // 计算需要合并的行数
                var mergeRows = 3; // 合并前三行
                
                // 生成表头
                html += '<tr>';
                html += '<th rowspan="' + mergeRows + '">对应的毕业要求指标点</th>';
                
                // 为每个课程目标生成表头，根据指标点数量设置 colspan
                objectiveInfos.forEach(function(info) {
                    if (info.indicatorNames.length > 1) {
                        html += '<th colspan="' + info.indicatorNames.length + '">课程目标' + info.index + '</th>';
                    } else {
                        html += '<th>课程目标' + info.index + '</th>';
                    }
                });
                html += '</tr>';
                
                // 生成毕业要求和支撑程度行
                html += '<tr>';
                objectiveInfos.forEach(function(info) {
                    if (info.indicatorNames.length > 1) {
                        html += '<td colspan="' + info.indicatorNames.length + '">' + (info.reqName || '毕业要求') + '[' + info.support + ']</td>';
                    } else {
                        html += '<td>' + (info.reqName || '毕业要求') + '[' + info.support + ']</td>';
                    }
                });
                html += '</tr>';
                
                // 生成指标点行
                html += '<tr>';
                objectiveInfos.forEach(function(info) {
                    info.indicatorNames.forEach(function(indicatorName) {
                        html += '<td>' + indicatorName + '</td>';
                    });
                });
                html += '</tr>';
                
                // 生成评价内容行
                html += '<tr>';
                html += '<td>评价内容</td>';
                objectiveInfos.forEach(function(info) {
                    // 每个课程目标只显示一次评价内容
                    var evalContent = '';
                    var objectiveIndex = info.index;
                    
                    // 获取平时成绩占比
                    var dailyPercentageElement = document.getElementById('objective-' + objectiveIndex + '-daily-percentage');
                    var dailyPercentage = dailyPercentageElement ? dailyPercentageElement.value : '0';
                    
                    // 获取期末成绩题目占比
                    var examItemsElement = document.getElementById('objective-' + objectiveIndex + '-exam-items');
                    var examItemsHtml = '';
                    
                    if (examItemsElement) {
                        var rows = examItemsElement.querySelectorAll('tr');
                        rows.forEach(function(row, index) {
                            var nameInput = row.querySelector('.question-name');
                            var scoreInput = row.querySelector('.question-score');
                            var percentageInput = row.querySelectorAll('input[type="number"]')[2];
                            
                            // 尝试其他可能的选择器
                            if (!percentageInput) {
                                // 尝试直接获取所有input，然后选择第三个
                                var allInputs = row.querySelectorAll('input');
                                if (allInputs.length >= 3) {
                                    percentageInput = allInputs[2];
                                }
                            }
                            
                            if (nameInput && scoreInput && percentageInput) {
                                var questionName = nameInput.value;
                                var questionScore = scoreInput.value;
                                var percentage = percentageInput.value;
                                
                                if (parseFloat(percentage) > 0) {
                                    examItemsHtml += questionName + questionScore + '(' + percentage + '%)+<br>';
                                }
                            }
                        });
                        
                        // 移除最后的 "+<br>"
                        if (examItemsHtml) {
                            examItemsHtml = examItemsHtml.slice(0, -5);
                        }
                    }
                    
                    // 如果没有获取到题目信息，尝试直接从DOM中获取
                    if (!examItemsHtml) {
                        // 直接查找所有可能的题目占比设置
                        var objectiveElements = document.querySelectorAll('.mb-8.border.border-gray-200.rounded-md.p-6');
                        objectiveElements.forEach(function(element, objIndex) {
                            var header = element.querySelector('h3');
                            if (header && header.textContent.includes('课程目标' + objectiveIndex)) {
                                var table = element.querySelector('table');
                                if (table) {
                                    var tableRows = table.querySelectorAll('tbody tr');
                                    tableRows.forEach(function(row) {
                                        var nameInput = row.querySelector('input[class*="question-name"]');
                                        var scoreInput = row.querySelector('input[class*="question-score"]');
                                        var percentageInput = row.querySelector('input[type="number"]:not([class*="question-name"]):not([class*="question-score"])');
                                        
                                        if (nameInput && scoreInput && percentageInput) {
                                            var questionName = nameInput.value;
                                            var questionScore = scoreInput.value;
                                            var percentage = percentageInput.value;
                                            
                                            if (parseFloat(percentage) > 0) {
                                                examItemsHtml += questionName + questionScore + '(' + percentage + '%)+<br>';
                                            }
                                        }
                                    });
                                    
                                    // 移除最后的 "+<br>"
                                    if (examItemsHtml) {
                                        examItemsHtml = examItemsHtml.slice(0, -5);
                                    }
                                }
                            }
                        });
                    }
                    
                    // 生成评价内容
                    if (parseFloat(dailyPercentage) > 0 && examItemsHtml) {
                        evalContent = examItemsHtml + '<br>平时成绩(' + dailyPercentage + '%)';
                    } else if (parseFloat(dailyPercentage) > 0) {
                        evalContent = '平时成绩(' + dailyPercentage + '%)';
                    } else if (examItemsHtml) {
                        evalContent = examItemsHtml;
                    } else {
                        evalContent = '无评价内容';
                    }
                    
                    // 根据指标点数量设置 colspan
                    if (info.indicatorNames.length > 1) {
                        html += '<td colspan="' + info.indicatorNames.length + '">' + evalContent + '</td>';
                    } else {
                        html += '<td>' + evalContent + '</td>';
                    }
                });
                html += '</tr>';
                
                return html;
            }
            
            // 下载报告文件
            function downloadReport(content, filename, fileType) {
                fileType = fileType || 'html';
                var mimeType = fileType === 'word' ? 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' : 'text/html;charset=utf-8';
                var blob = new Blob(['\ufeff' + content], { type: mimeType });
                var url = URL.createObjectURL(blob);
                var link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            // 确保添加课程目标按钮只添加一个课程目标
            document.addEventListener('DOMContentLoaded', function() {
                var addObjectiveBtn = document.getElementById('add-objective');
                if (addObjectiveBtn) {
                    // 移除所有现有的事件监听器
                    var newBtn = addObjectiveBtn.cloneNode(true);
                    addObjectiveBtn.parentNode.replaceChild(newBtn, addObjectiveBtn);
                    
                    // 添加唯一的事件监听器
                    newBtn.addEventListener('click', function() {
                        var courseObjectives = document.getElementById('course-objectives');
                        var objectiveCount = courseObjectives.children.length + 1;

                        var newObjective = document.createElement('div');
                        newObjective.className = 'objective-item border border-gray-200 rounded-md p-4 mb-4';
                        newObjective.innerHTML = '<div class="flex justify-between items-center mb-4">' +
                            '<h4 class="font-medium">课程目标' + objectiveCount + '</h4>' +
                            '<button class="delete-objective-btn text-red-500 hover:text-red-700 text-sm">删除</button>' +
                        '</div>' +
                        '<div class="grid grid-cols-1 md:grid-cols-4 gap-4">' +
                            '<div>' +
                                '<label class="block text-gray-700 mb-2">目标描述</label>' +
                                '<textarea id="objective-' + objectiveCount + '-desc" rows="3" ' +
                                          'class="w-full px-4 py-2 border border-gray-300 rounded-md form-input-focus"></textarea>' +
                            '</div>' +
                            '<div>' +
                                '<label class="block text-gray-700 mb-2">对应毕业要求指标点</label>' +
                                '<input type="text" id="objective-' + objectiveCount + '-requirement" ' +
                                       'class="w-full px-4 py-2 border border-gray-300 rounded-md form-input-focus">' +
                            '</div>' +
                            '<div>' +
                                '<label class="block text-gray-700 mb-2">支撑程度</label>' +
                                '<select id="objective-' + objectiveCount + '-support-level" ' +
                                        'class="w-full px-4 py-2 border border-gray-300 rounded-md form-input-focus">' +
                                    '<option value="H">H（高）</option>' +
                                    '<option value="M" selected>M（中）</option>' +
                                    '<option value="L">L（低）</option>' +
                                '</select>' +
                            '</div>' +
                            '<div>' +
                                '<label class="block text-gray-700 mb-2">对应毕业要求具体指标点</label>' +
                                '<textarea id="objective-' + objectiveCount + '-specific-requirement" rows="3" ' +
                                          'class="w-full px-4 py-2 border border-gray-300 rounded-md form-input-focus"></textarea>' +
                            '</div>' +
                        '</div>';

                        courseObjectives.appendChild(newObjective);

                        // 在权重设置部分添加对应的课程目标行
                        var weightResultsBody = document.getElementById('weight-results');
                        if (weightResultsBody) {
                            var newWeightRow = document.createElement('tr');
                            newWeightRow.innerHTML = '<td class="px-6 py-4 whitespace-nowrap">课程目标' + objectiveCount + '</td>' +
                                '<td class="px-6 py-4 whitespace-nowrap"></td>' +
                                '<td class="px-6 py-4 whitespace-nowrap font-medium text-primary">0.000</td>';
                            weightResultsBody.appendChild(newWeightRow);
                        }

                        // 在权重设置部分添加对应的平时成绩占比和期末成绩题目设置
                        var step2Content = document.getElementById('step-2');
                        if (step2Content) {
                            // 创建新的课程目标权重设置部分
                            var newObjectiveWeightSection = document.createElement('div');
                            newObjectiveWeightSection.className = 'mb-0 border border-gray-200 rounded-md p-6';
                            newObjectiveWeightSection.innerHTML = '<h3 class="text-lg font-semibold mb-4">课程目标' + objectiveCount + '</h3>' +
                                '<div class="mb-4">' +
                                    '<label class="block text-gray-700 mb-2">平时成绩占比（%）</label>' +
                                    '<input type="number" id="objective-' + objectiveCount + '-daily-percentage" class="w-full px-4 py-2 border border-gray-300 rounded-md form-input-focus" value="33" min="0" max="100">' +
                                '</div>' +
                                '<div>' +
                                        '<h4 class="font-medium mb-2">期末成绩题目设置</h4>' +
                                        '<div class="flex justify-between items-center mb-2">' +
                                            '<p class="text-gray-600">请输入期末每一个小题的占比（总分已从期末考试设置中同步）</p>' +
                                        '</div>' +
                                        '<div class="overflow-x-auto">' +
                                        '<table class="min-w-full divide-y divide-gray-200">' +
                                            '<thead class="bg-gray-50">' +
                                                '<tr>' +
                                                    '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">题目</th>' +
                                                    '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">总分</th>' +
                                                    '<th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">占比（%）</th>' +
                                                '</tr>' +
                                            '</thead>' +
                                            '<tbody class="bg-white divide-y divide-gray-200" id="objective-' + objectiveCount + '-exam-items">' +
                                            '</tbody>' +
                                        '</table>' +
                                    '</div>' +
                                '</div>';
                            
                            // 将新的课程目标权重设置部分添加到步骤2的grid容器中
                            var objectivesContainer = document.getElementById('objectives-container');
                            if (objectivesContainer) {
                                objectivesContainer.appendChild(newObjectiveWeightSection);
                            } else {
                                // 如果grid容器不存在，添加到权重结果表格之前
                                var weightResultsTable = document.getElementById('weight-results');
                                if (weightResultsTable) {
                                    var parentElement = weightResultsTable.closest('div');
                                    if (parentElement) {
                                        parentElement.parentNode.insertBefore(newObjectiveWeightSection, parentElement);
                                    }
                                }
                            }
                        }
                        
                        // 同步所有课程目标的期末成绩题目设置
                        syncAllObjectivesExamItems();

                        // 添加删除事件
                        var deleteButton = newObjective.querySelector('.delete-objective-btn');
                        deleteButton.addEventListener('click', function() {
                            newObjective.parentNode.removeChild(newObjective);
                            // 更新目标编号
                            updateObjectiveNumbers();
                            // 删除对应权重行
                            var weightResultsBody = document.getElementById('weight-results');
                            if (weightResultsBody) {
                                var weightRows = weightResultsBody.querySelectorAll('tr');
                                if (weightRows.length > objectiveCount - 1) {
                                    weightRows[objectiveCount - 1].parentNode.removeChild(weightRows[objectiveCount - 1]);
                                }
                            }
                            // 删除对应权重设置部分
                            var objectivesContainer = document.getElementById('objectives-container');
                            var objectiveWeightSections;
                            
                            if (objectivesContainer) {
                                // 如果在grid容器中，查找所有课程目标div
                                objectiveWeightSections = objectivesContainer.querySelectorAll('.border.border-gray-200.rounded-md.p-6');
                            } else {
                                // 否则在step2Content中查找
                                var step2Content = document.getElementById('step-2');
                                if (step2Content) {
                                    objectiveWeightSections = step2Content.querySelectorAll('.mb-8.border.border-gray-200.rounded-md.p-6');
                                }
                            }
                            
                            if (objectiveWeightSections && objectiveWeightSections.length > objectiveCount - 1) {
                                objectiveWeightSections[objectiveCount - 1].parentNode.removeChild(objectiveWeightSections[objectiveCount - 1]);
                            }
                            // 同步所有课程目标的期末成绩题目设置
                            syncAllObjectivesExamItems();
                        });
                    });
                }
            });

    </script>
</body>
</html>